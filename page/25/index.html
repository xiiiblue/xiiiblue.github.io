<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.bluexiii.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="IT技术类文章、笔记分享">
<meta property="og:type" content="website">
<meta property="og:title" content="BlueXIII&#39;s Blog">
<meta property="og:url" content="http://www.bluexiii.com/page/25/index.html">
<meta property="og:site_name" content="BlueXIII&#39;s Blog">
<meta property="og:description" content="IT技术类文章、笔记分享">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="BlueXIII">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://www.bluexiii.com/page/25/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>BlueXIII's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BlueXIII's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">热爱技术,持续学习</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201707/%E9%80%9A%E8%BF%87Cookie%20Insertion%E5%AE%9E%E7%8E%B0Nginx%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%80%9A%E8%BF%87Cookie%20Insertion%E5%AE%9E%E7%8E%B0Nginx%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81/" class="post-title-link" itemprop="url">通过Cookie Insertion实现Nginx会话保持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:36:54" itemprop="dateCreated datePublished" datetime="2018-11-06T15:36:54+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Nginx负载均衡的几种策略"><a href="#Nginx负载均衡的几种策略" class="headerlink" title="Nginx负载均衡的几种策略"></a>Nginx负载均衡的几种策略</h2><p>使用开源版本的Nginx可以轻松实现7层（HTTP）或4层（TCP）的负载均衡。  </p>
<p>当做为7层负载时，最常用的有以下几种策略：  </p>
<ul>
<li>轮询 round-robin — requests to the application servers are distributed in a round-robin fashion 依次把客户端的请求分发到不同的后端服务器上</li>
<li>最少连接 least-connected — next request is assigned to the server with the least number of active connections  请求会被转发到连接数最少的服务器上</li>
<li>IP哈希 ip-hash — a hash-function is used to determine what server should be selected for the next request (based on the client’s IP address)  同一客户端（IP）的连续的请求都会被分发到固定的一台后端服务器上</li>
</ul>
<p>前两种方案（轮询和最少连接）同一客户端的请求会被随机分配后不同的后端服务器上，如果后端是传统的有状态的WEB应用，则需要在后端WEB容器上配置Session共享，非常麻烦。</p>
<p>后一种方案（IP哈希）可以识别请求端的IP，固定将其分配到某一台后端服务器上，轻松解决了会话保持的问题。但IP哈希存在一个比较严重缺陷，即：客户端必须能够直连Nginx服务器，他们之间不能再插入其它层级，否则Nginx就识别不到客户端的IP了。  </p>
<p>那除了IP HASH外，还有没有其它方式能够进行会话保持呢？  </p>
<h2 id="Cookie-Insertion"><a href="#Cookie-Insertion" class="headerlink" title="Cookie Insertion"></a>Cookie Insertion</h2><p>以下是官网的关于Cookie Insertion的介绍：  </p>
<blockquote>
<p>Cookie Insertion：NGINX Plus adds a session cookie to the first response from the upstream group to a given client, identifying which server generated the response (in an encoded fashion). Subsequent requests from the client include the cookie value and NGINX Plus uses it to route the request to the same upstream server:</p>
</blockquote>
<p>Cookie植入:  </p>
<ol>
<li>客户端第一次访问时，负载均衡服务在返回请求中植入cookie（在HTTP/HTTPS响应报文中插入）</li>
<li>下次客户端携带此cookie访问，负载均衡服务会将请求定向转发给之前记录到的后端服务器上。</li>
</ol>
<p>Cookie植入原理上就是劫持HTTP请求，伪造cookie，它可以在Nginx无法获取客户端IP时，也依然能够完成会话保持的功能，只要客户端支持Cookie即可。</p>
<h2 id="购买并使用Nginx-Plus"><a href="#购买并使用Nginx-Plus" class="headerlink" title="购买并使用Nginx Plus"></a>购买并使用Nginx Plus</h2><p>要使用Cookie Insertion，最简便的方式是使用商业版本的Nginx Plus，默认支持。  </p>
<p>以下是官网关于会话保持的介绍：<br><a target="_blank" rel="noopener" href="https://www.nginx.com/products/session-persistence/">https://www.nginx.com/products/session-persistence/</a></p>
<p>Cookie Insertion的配置非常简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server webserver1;</span><br><span class="line">    server webserver2;</span><br><span class="line">    sticky cookie srv_id expires&#x3D;1h domain&#x3D;.example.com path&#x3D;&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是顺道了解了一下Nginx Plus的来龙去脉：  </p>
<ul>
<li>2002年，来自俄罗斯的Igor Sysoev使用C语言开发了NGINX；</li>
<li>2004年，NGINX开放源码，基于BSD开源许可。</li>
<li>2006年 - 2016年，NIGNX Rlease版本历经0.5, 0.6, 0.7, 0.8, 1.0, 1.2, 1.4, 1.6, 1.8, 1.9, 1.10, 1.11, 当前最新版本为1.11.3；</li>
<li>2011年，Sysoev成立了NGINX公司，NGINX PLUS是其第一款产品，也是NGINX的商业版本；</li>
<li>2013年 - 2016年，自NGINX Plus Initial Release (R1)版本发布以来，NGINX商业版本已更新至NGINX Plus Release 9 (R9)；</li>
</ul>
<blockquote>
<p>NGINX Plus is the all-in-one application delivery platform for the modern web.<br>All-In-One的NGINX PLUS对比开源版本重点增加了若干企业特性，包括更完善的七层、四层负载均衡，会话保持，健康检查，实时监控和管理等。</p>
</blockquote>
<p>可看了一下最便宜的BASIC版本也要2500刀每年，泪奔，果断PASS。<br><a target="_blank" rel="noopener" href="https://www.nginx.com/products/buy-nginx-plus/">https://www.nginx.com/products/buy-nginx-plus/</a></p>
<h2 id="使用第三方模块nginx-sticky-module"><a href="#使用第三方模块nginx-sticky-module" class="headerlink" title="使用第三方模块nginx-sticky-module"></a>使用第三方模块nginx-sticky-module</h2><p>阿里云SLB的Cookie植入功能，猜测应该是自已在Nginx基础上实现的，貌似没有开源。  </p>
<p>流传最广的是一个名为 <strong>nginx-sticky-module</strong> 的第3方的模块 ，不过已经有多年没有维护。</p>
<p>GoogleCode页面(需扶墙): <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/nginx-sticky-module/downloads">https://code.google.com/archive/p/nginx-sticky-module/downloads</a></p>
<p>下载 <strong>nginx-sticky-module-1.1.tar.gz</strong> ，看看能否配合较新的 <strong>nginx-1.12.1</strong> 使用。</p>
<p>Nginx下载地址： <a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a>  </p>
<blockquote>
<p>选择Stable version中的nginx-1.12.1</p>
</blockquote>
<p>简单编译一下试试：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;nginx&#x2F;nginx-1.12.1 --add-module&#x3D;&#x2F;nginx&#x2F;src&#x2F;nginx-sticky-module-1.1  </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>果然报错：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;nginx&#x2F;src&#x2F;nginx-sticky-module-1.1&#x2F;ngx_http_sticky_module.c: In function ‘ngx_http_get_sticky_peer’:</span><br><span class="line">&#x2F;nginx&#x2F;src&#x2F;nginx-sticky-module-1.1&#x2F;ngx_http_sticky_module.c:333: error: assignment makes pointer from integer without a cast</span><br><span class="line">make[1]: *** [objs&#x2F;addon&#x2F;nginx-sticky-module-1.1&#x2F;ngx_http_sticky_module.o] Error 1</span><br><span class="line">make[1]: Leaving directory &#96;&#x2F;nginx&#x2F;src&#x2F;nginx-1.12.1&#39;</span><br><span class="line">make: *** [build] Error 2</span><br></pre></td></tr></table></figure>
<p>代码太老旧，没有细查的必要了，弃用。  </p>
<h2 id="使用第三方模块nginx-sticky-module-ng"><a href="#使用第三方模块nginx-sticky-module-ng" class="headerlink" title="使用第三方模块nginx-sticky-module-ng"></a>使用第三方模块nginx-sticky-module-ng</h2><p>另外还有一个比较新的模块 <strong>nginx-sticky-module-ng</strong> ，源码托管在BitBucket上：<br><a target="_blank" rel="noopener" href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/</a>  </p>
<p>在Downloads/Tags下，找到1.2.6的源码并下载，或者直接下载Master分支上最新的代码。</p>
<p>在编译之前，首先来动手修复一个BUG。。。<br>找到<code>ngx_http_sticky_misc.c</code>，添加以下两个include:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;openssl&#x2F;sha.h&gt;</span><br><span class="line">#include &lt;openssl&#x2F;md5.h&gt;</span><br></pre></td></tr></table></figure>
<p>第三方的东西凑和着用吧。。。</p>
<p>编译一下试试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;nginx&#x2F;nginx-1.12.1 --add-module&#x3D;&#x2F;nginx&#x2F;src&#x2F;nginx-sticky-module-ng</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>编译很顺利，配置一下试试吧：<br>配置上非常简单，只需要在upstream{}中加入sticky即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upstream &#123;</span><br><span class="line">  sticky;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Sticky的详细配置说明：<br>sticky [name=route] [domain=.foo.bar] [path=/] [expires=1h]<br>       [hash=index|md5|sha1] [no_fallback] [secure] [httponly];</p>
<ul>
<li>name: the name of the cookies used to track the persistant upstream srv; default: route</li>
<li>domain: the domain in which the cookie will be valid default: nothing. Let the browser handle this.</li>
<li>path: the path in which the cookie will be valid default: /</li>
<li>expires: the validity duration of the cookie default: nothing. It’s a session cookie. restriction: must be a duration greater than one second</li>
<li>hash: the hash mechanism to encode upstream server. It cant’ be used with hmac. default: md5</li>
<li>md5|sha1: well known hash</li>
<li>index: it’s not hashed, an in-memory index is used instead, it’s quicker and the overhead is shorter Warning: the matching against upstream servers list is inconsistent. So, at reload, if upstreams servers has changed, index values are not guaranted to correspond to the same server as before! USE IT WITH CAUTION and only if you need to!</li>
<li>hmac: the HMAC hash mechanism to encode upstream server It’s like the hash mechanism but it uses hmac_key to secure the hashing. It can’t be used with hash. md5|sha1: well known hash default: none. see hash.</li>
<li>hmac_key: the key to use with hmac. It’s mandatory when hmac is set default: nothing.</li>
<li>no_fallback: when this flag is set, nginx will return a 502 (Bad Gateway or Proxy Error) if a request comes with a cookie and the corresponding backend is unavailable.</li>
<li>secure enable secure cookies; transferred only via https</li>
<li>httponly enable cookies not to be leaked via js</li>
</ul>
<p>下面给出一个完整的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  4;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    upstream proxy_admin &#123;</span><br><span class="line">        #ip_hash;</span><br><span class="line">        sticky;</span><br><span class="line">        server 192.168.1.61:19022 weight&#x3D;10 max_fails&#x3D;3 fail_timeout&#x3D;20s;</span><br><span class="line">        server 192.168.1.62:19022 weight&#x3D;10 max_fails&#x3D;3 fail_timeout&#x3D;20s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       29022;</span><br><span class="line">        server_name  proxy_admin;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            proxy_pass   http:&#x2F;&#x2F;proxy_admin;</span><br><span class="line">            proxy_next_upstream error timeout invalid_header http_500 http_503 http_404;</span><br><span class="line">            proxy_redirect off;</span><br><span class="line">            proxy_ignore_client_abort on;</span><br><span class="line">            proxy_set_header Host $host:$server_port;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_connect_timeout 60;</span><br><span class="line">            proxy_send_timeout 60;</span><br><span class="line">            proxy_read_timeout 60;</span><br><span class="line">            proxy_buffer_size 4k;</span><br><span class="line">            proxy_buffers 4 32k;</span><br><span class="line">            proxy_busy_buffers_size 64k;</span><br><span class="line">            proxy_temp_file_write_size 64k;</span><br><span class="line">            client_body_buffer_size 128k;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试，用浏览器访问一下试试：<br><a target="_blank" rel="noopener" href="http://ip:29022/mobagent-admin/">http://IP:29022/mobagent-admin/</a><br>如果在控制台中的Cookie中看到一个名为route的键，就说明基本上成功了。<br>然后多请求几次，看看后端服务的日志，最终确认一下，是不是只指向了同一台服务器。  </p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>最后，请注意，因为nginx-sticky-module-ng的可靠性未经长时间验证，请勿直接用于生产系统。  </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201707/%E9%98%BF%E9%87%8C%E4%BA%91OSS%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%98%BF%E9%87%8C%E4%BA%91OSS%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E7%A4%BA%E4%BE%8B/" class="post-title-link" itemprop="url">阿里云OSS对象存储示例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:36:33" itemprop="dateCreated datePublished" datetime="2018-11-06T15:36:33+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="DEMO-GitLab"><a href="#DEMO-GitLab" class="headerlink" title="DEMO GitLab"></a>DEMO GitLab</h2><blockquote>
<p>更多源码请移步GitHub<br><a target="_blank" rel="noopener" href="https://github.com/xiiiblue/demo-oss">https://github.com/xiiiblue/demo-oss</a></p>
</blockquote>
<h2 id="OSS-SDK下载"><a href="#OSS-SDK下载" class="headerlink" title="OSS SDK下载"></a>OSS SDK下载</h2><p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/act/ossdoclist.html">https://promotion.aliyun.com/ntms/act/ossdoclist.html</a></p>
<h2 id="OSS-SDK源码"><a href="#OSS-SDK源码" class="headerlink" title="OSS SDK源码"></a>OSS SDK源码</h2><p><a target="_blank" rel="noopener" href="https://github.com/aliyun/aliyun-oss-java-sdk">https://github.com/aliyun/aliyun-oss-java-sdk</a></p>
<h2 id="OSS-Maven依赖"><a href="#OSS-Maven依赖" class="headerlink" title="OSS Maven依赖"></a>OSS Maven依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="OSS官方文档"><a href="#OSS官方文档" class="headerlink" title="OSS官方文档"></a>OSS官方文档</h2><p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/32009.html">https://help.aliyun.com/document_detail/32009.html</a></p>
<h2 id="申请及配置OSS流程"><a href="#申请及配置OSS流程" class="headerlink" title="申请及配置OSS流程"></a>申请及配置OSS流程</h2><ol>
<li><p>登录aliyun后，进入OSS控制台:<br><a target="_blank" rel="noopener" href="https://oss.console.aliyun.com/overview">https://oss.console.aliyun.com/overview</a></p>
</li>
<li><p>右侧点击”购买资源包”，选择合适的档位，付费购买。</p>
</li>
<li><p>右侧点击”新建Bucket”，输入一个全局唯一的bucket名，并选择所属地域，新建Bucket。</p>
</li>
<li><p>左侧列表中，进入新建的Bucket，可以查询到”Endpoint”</p>
</li>
<li><p>获取AK，可以直接访问链接：<br><a target="_blank" rel="noopener" href="https://ak-console.aliyun.com/#/accesskey">https://ak-console.aliyun.com/#/accesskey</a></p>
</li>
</ol>
<h2 id="常用操作示例"><a href="#常用操作示例" class="headerlink" title="常用操作示例"></a>常用操作示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(OssComponent.class);</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;aliyun.oss.endpoint&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String endpoint;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OSSClient ossClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过bucket与fileKey获取URL</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">urlFromFileKey</span><span class="params">(String bucket, String fileKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;http://&quot;</span> + bucket + <span class="string">&quot;.&quot;</span> + <span class="keyword">this</span>.endpoint + <span class="string">&quot;/&quot;</span> + fileKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传本地文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket   Bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath 本地文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey  指定OSS文件名，传空时自动生成UUID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> FileNotFoundException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">putObject</span><span class="params">(String bucket, String filePath, String fileKey)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fileKey == <span class="keyword">null</span>) &#123;</span><br><span class="line">        fileKey = UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>) + filePath.substring(filePath.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ossClient.putObject(bucket, fileKey, <span class="keyword">new</span> File(filePath));</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;OSS putObject success! fileKey=&#123;&#125;&quot;</span>, fileKey);</span><br><span class="line">    <span class="keyword">return</span> fileKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下载文件到本地目录</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket    Bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey   OSS文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localPath 本地文件目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getObject</span><span class="params">(String bucket, String fileKey, String localPath)</span> </span>&#123;</span><br><span class="line">    String localFileKey = localPath + fileKey;</span><br><span class="line">    ossClient.getObject(<span class="keyword">new</span> GetObjectRequest(bucket, fileKey), <span class="keyword">new</span> File(localFileKey));</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;OSS getObject success! localFileKey=&#123;&#125;&quot;</span>, localFileKey);</span><br><span class="line">    <span class="keyword">return</span> localFileKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查文件是否存在</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  Bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey OSS文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkObject</span><span class="params">(String bucket, String fileKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ossClient.doesObjectExist(bucket, fileKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列出所有文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket    Bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keyPrifix 文件名前缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listObjects</span><span class="params">(String bucket, String keyPrifix)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; fileList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    ObjectListing objectListing = ossClient.listObjects(bucket, keyPrifix);</span><br><span class="line">    List&lt;OSSObjectSummary&gt; sums = objectListing.getObjectSummaries();</span><br><span class="line">    <span class="keyword">for</span> (OSSObjectSummary s : sums) &#123;</span><br><span class="line">        fileList.add(bucket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fileList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteObject</span><span class="params">(String bucket, String fileKey)</span> </span>&#123;</span><br><span class="line">    ossClient.deleteObject(bucket, fileKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(OssComponentTest.class);</span><br><span class="line"><span class="keyword">private</span> String localPath;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">OssComponent ossComponent;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OssComponentTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    localPath = System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;upload/&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">urlFromFileKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String fileKey = <span class="string">&quot;0c2eb1357a454c71b71aa20462951ac4.jpg&quot;</span>;</span><br><span class="line">    String url = ossComponent.urlFromFileKey(bucket, fileKey);</span><br><span class="line"></span><br><span class="line">    logger.debug(url);</span><br><span class="line">    assertNotNull(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String filePath = localPath + <span class="string">&quot;sonic.jpg&quot;</span>;</span><br><span class="line"></span><br><span class="line">    String fileKey = ossComponent.putObject(bucket, filePath, <span class="keyword">null</span>);</span><br><span class="line">    logger.debug(fileKey);</span><br><span class="line">    assertNotNull(fileKey);</span><br><span class="line"></span><br><span class="line">    fileKey = ossComponent.putObject(bucket, filePath, <span class="string">&quot;sonic.jpg&quot;</span>);</span><br><span class="line">    logger.debug(fileKey);</span><br><span class="line">    assertNotNull(fileKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String fileKey = <span class="string">&quot;0c2eb1357a454c71b71aa20462951ac4.jpg&quot;</span>;</span><br><span class="line">    String localPath = <span class="keyword">this</span>.localPath;</span><br><span class="line"></span><br><span class="line">    String localFileKey = ossComponent.getObject(bucket, fileKey, localPath);</span><br><span class="line"></span><br><span class="line">    logger.debug(localFileKey);</span><br><span class="line">    assertNotNull(localFileKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String fileKey = <span class="string">&quot;0c2eb1357a454c71b71aa20462951ac4.jpg&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> flag = ossComponent.checkObject(bucket, fileKey);</span><br><span class="line"></span><br><span class="line">    assertTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listObjects</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String keyPrifix = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; list = ossComponent.listObjects(bucket, keyPrifix);</span><br><span class="line"></span><br><span class="line">    logger.debug(list.toString());</span><br><span class="line">    assertTrue(list.size() &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String fileKey = <span class="string">&quot;sonic.jpg&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ossComponent.deleteObject(bucket, fileKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">阿里云DRDS分库分表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:36:19" itemprop="dateCreated datePublished" datetime="2018-11-06T15:36:19+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>以下大部分内容非原创，整理自阿里云官方文档</p>
</blockquote>
<h2 id="单库单表"><a href="#单库单表" class="headerlink" title="单库单表"></a>单库单表</h2><p>建一张单库单表，不做任何拆分。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> single_tbl(</span><br><span class="line">  id <span class="type">int</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">  <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> single_tbl;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> normal_table(</span><br><span class="line">id <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line"><span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
<h2 id="分库不分表"><a href="#分库不分表" class="headerlink" title="分库不分表"></a>分库不分表</h2><p>假设已经建好的分库数为 8，建一张表，只分库不分表，分库方式为根据 id 列哈希。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> multi_db_single_tbl(</span><br><span class="line">  id <span class="type">int</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">  <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) dbpartition <span class="keyword">by</span> hash(id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> multi_db_single_tbl;</span><br></pre></td></tr></table></figure>
<h2 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h2><h3 id="使用哈希函数做拆分"><a href="#使用哈希函数做拆分" class="headerlink" title="使用哈希函数做拆分"></a>使用哈希函数做拆分</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> multi_db_multi_tbl(</span><br><span class="line">  id <span class="type">int</span> auto_increment,</span><br><span class="line">  bid <span class="type">int</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">  <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) dbpartition <span class="keyword">by</span> hash(id) tbpartition <span class="keyword">by</span> hash(bid) tbpartitions <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> multi_db_multi_tbl;</span><br></pre></td></tr></table></figure>
<h3 id="使用双字段哈希函数做拆分"><a href="#使用双字段哈希函数做拆分" class="headerlink" title="使用双字段哈希函数做拆分"></a>使用双字段哈希函数做拆分</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_order_tb (  </span><br><span class="line">          id <span class="type">int</span>,</span><br><span class="line">          seller_id <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,  </span><br><span class="line">          buyer_id <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">          create_time datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">          <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">  ) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 dbpartition <span class="keyword">by</span> RANGE_HASH(seller_id,buyer_id, <span class="number">10</span>) tbpartition <span class="keyword">by</span> RANGE_HASH(seller_id,buyer_id, <span class="number">10</span>) tbpartitions <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> multi_db_multi_tbl;</span><br></pre></td></tr></table></figure>
<h3 id="使用日期做拆分"><a href="#使用日期做拆分" class="headerlink" title="使用日期做拆分"></a>使用日期做拆分</h3><p>可以使用日期函数 MM/DD/WEEK/MMDD 来作为分表的拆分算法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_log(</span><br><span class="line">userId <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">operation <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">actionDate <span class="type">DATE</span></span><br><span class="line">) dbpartition <span class="keyword">by</span> hash(userId) tbpartition <span class="keyword">by</span> WEEK(actionDate) tbpartitions <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> user_log;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_log2(</span><br><span class="line">userId <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">operation <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">actionDate <span class="type">DATE</span></span><br><span class="line">) dbpartition <span class="keyword">by</span> hash(userId) tbpartition <span class="keyword">by</span> MM(actionDate) tbpartitions <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> user_log2;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="默认使用主键作为拆分字段"><a href="#默认使用主键作为拆分字段" class="headerlink" title="默认使用主键作为拆分字段"></a>默认使用主键作为拆分字段</h2><p>当拆分算法不指定任何拆分字段时，系统默认使用主键作为拆分字段。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prmkey_tbl(</span><br><span class="line">id <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line"><span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) dbpartition <span class="keyword">by</span> hash();</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prmkey_multi_tbl(</span><br><span class="line">id <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line"><span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) dbpartition <span class="keyword">by</span> hash() tbpartition <span class="keyword">by</span> hash() tbpartitions <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<h2 id="广播表"><a href="#广播表" class="headerlink" title="广播表"></a>广播表</h2><p>子句BROADCAST用来指定创建广播表。广播表是指将这个表复制到每个分库上，在分库上通过同步机制实现数据一致，有秒级延迟。<br>这样做的好处是可以将 JOIN 操作下推到底层的 RDS（MySQL)，来避免跨库 JOIN。  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> brd_tbl(</span><br><span class="line">  id <span class="type">int</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">  <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 BROADCAST;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>直接在客户端使用DDL建表好像并不成功，尽量使用WEB控制台建表</p>
</blockquote>
<h2 id="其它操作"><a href="#其它操作" class="headerlink" title="其它操作"></a>其它操作</h2><h3 id="查看物理表的拓扑结构"><a href="#查看物理表的拓扑结构" class="headerlink" title="查看物理表的拓扑结构"></a>查看物理表的拓扑结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TOPOLOGY <span class="keyword">FROM</span> multi_db_multi_tbl;</span><br></pre></td></tr></table></figure>
<h3 id="查看逻辑表是否创建成功"><a href="#查看逻辑表是否创建成功" class="headerlink" title="查看逻辑表是否创建成功"></a>查看逻辑表是否创建成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CHECK</span> <span class="keyword">TABLE</span> multi_db_multi_tbl;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%E4%BD%BF%E7%94%A8%E9%99%90%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%E4%BD%BF%E7%94%A8%E9%99%90%E5%88%B6/" class="post-title-link" itemprop="url">阿里云DRDS使用限制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:36:05" itemprop="dateCreated datePublished" datetime="2018-11-06T15:36:05+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>以下大部分内容非原创，整理自阿里云官方文档</p>
</blockquote>
<h2 id="SQL大类限制"><a href="#SQL大类限制" class="headerlink" title="SQL大类限制"></a>SQL大类限制</h2><ul>
<li>暂不支持用户自定义数据类型、自定义函数。</li>
<li>暂不支持视图、存储过程、触发器、游标。</li>
<li>暂不支持 BEGIN…END、LOOP…END LOOP、REPEAT…UNTIL…END REPEAT、WHILE…DO…END WHILE 等复合语句。</li>
<li>暂不支类似 IF ，WHILE 等流程控制类语句。</li>
</ul>
<h2 id="DDL限制"><a href="#DDL限制" class="headerlink" title="DDL限制"></a>DDL限制</h2><ul>
<li>CREATE TABLE tbl_name LIKE old_tbl_name 不支持拆分表。</li>
<li>CREATE TABLE tbl_name SELECT statement 不支持拆分表。</li>
</ul>
<h2 id="数据库管理限制"><a href="#数据库管理限制" class="headerlink" title="数据库管理限制"></a>数据库管理限制</h2><ul>
<li>SHOW WARNINGS Syntax 不支持 LIMIT/COUNT 的组合。</li>
<li>SHOW ERRORS Syntax 不支持 LIMIT/COUNT 的组合。</li>
</ul>
<h2 id="DML限制"><a href="#DML限制" class="headerlink" title="DML限制"></a>DML限制</h2><ul>
<li>暂不支持 SELECT INTO OUTFILE/INTO DUMPFILE/INTO var_name。</li>
<li>暂不支持 INSERT DELAYED Syntax。</li>
<li>暂不支持非 WHERE 条件的 Correlate Subquery。</li>
<li>暂不支持 SQL 中带聚合条件的 Correlate Subquery。</li>
<li>暂不支持 SQL 中对于变量的引用和操作，比如 SET @c=1, @d=@c+1; SELECT @c, @d。</li>
</ul>
<blockquote>
<p>关于 Correlated Subquery 的解释：<br>Correlated Subquery is a sub-query that uses values from the outer query. In this case the inner query has to be executed for every row of outer query.<br>See example here <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Correlated_subquery">http://en.wikipedia.org/wiki/Correlated_subquery</a><br>Simple subquery doesn’t use values from the outer query and is being calculated only once:  </p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id, first_name</span><br><span class="line"><span class="keyword">FROM</span> student_details</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> student_id</span><br><span class="line"><span class="keyword">FROM</span> student_subjects</span><br><span class="line"><span class="keyword">WHERE</span> subject<span class="operator">=</span> <span class="string">&#x27;Science&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>DDL限制、数据库管理限制，由于与应用关系不大，编码时无须特别关心。<br>SQL大类限制，如视图、存储过程、触发器、游标等，通常是不被提倡的坏味道，如果有的话，直接改方式实现即可。<br>DML限制，需要特别注意。如果使用ORM，应该不会有太大问题，但用jdbcTemplate写原生SQL的话（如实时报表类的功能点）有可能会踩坑。<br>另外默认不支持跨实例事务，私有云貌似也没有GTS选项，需要在代码层面进行优化。</p>
<h2 id="DML错误示例"><a href="#DML错误示例" class="headerlink" title="DML错误示例"></a>DML错误示例</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> id,name <span class="keyword">from</span> normal_tables) t</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[b8040ac9f401000][192.168.2.47:3306][dev_sc_dmanage]ERR-CODE: [TDDL-4007][ERR_CANNOT_FETCH_TABLE_META] Table ‘normal_tables’ metadata cannot be fetched because Table ‘dev_sc_dmanage_ssiu_0000.normal_tables’ doesn’t exist. More: [<a target="_blank" rel="noopener" href="http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4007%5D">http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4007]</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a,<span class="operator">*</span>,b.<span class="operator">*</span> <span class="keyword">from</span> shard_table a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> id,name <span class="keyword">from</span> normal_table) b <span class="keyword">on</span> b.id<span class="operator">=</span>a.id;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[b80405010801000][192.168.2.47:3306][dev_sc_dmanage]column: a is not existed in either null or select clause</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a,<span class="operator">*</span>,b.<span class="operator">*</span> <span class="keyword">from</span> normal_tables a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> id,name <span class="keyword">from</span> shard_table) b <span class="keyword">on</span> b.id<span class="operator">=</span>a.id;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[b8040692c001000][192.168.2.47:3306][dev_sc_dmanage]ERR-CODE: [TDDL-4007][ERR_CANNOT_FETCH_TABLE_META] Table ‘normal_tables’ metadata cannot be fetched because Table ‘dev_sc_dmanage_ssiu_0000.normal_tables’ doesn’t exist. More: [<a target="_blank" rel="noopener" href="http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4007%5D">http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4007]</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> group_seq_tbl (name) <span class="keyword">values</span> (<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> group_seq_tbl (name) <span class="keyword">values</span> (<span class="string">&#x27;hello&#x27;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[b807dfe12c01000-24][192.168.2.47:3306][dev_sc_dmanage]ERR-CODE: [TDDL-4603][ERR_ACCROSS_DB_TRANSACTION] Transaction accross db is not supported in current transaction policy, transaction node is: DEV_SC_DMANAGE_1501040729564NYQSDEV_SC_DMANAGE_SSIU_0003_RDS, but this sql execute on: DEV_SC_DMANAGE_1501040729564NYQSDEV_SC_DMANAGE_SSIU_0006_RDS. More: [<a target="_blank" rel="noopener" href="http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4603%5D">http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4603]</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%20Sequence/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%20Sequence/" class="post-title-link" itemprop="url">阿里云DRDS Sequence</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:35:55" itemprop="dateCreated datePublished" datetime="2018-11-06T15:35:55+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>以下大部分内容非原创，整理自阿里云官方文档</p>
</blockquote>
<h2 id="DRDS-Sequence简介"><a href="#DRDS-Sequence简介" class="headerlink" title="DRDS Sequence简介"></a>DRDS Sequence简介</h2><p>DRDS 全局唯一数字序列（64 位数字，对应 MySQL 中 Signed BIGINT 类型）的主要目标是为了生成全局唯一和有序递增的数字序列，<strong>常用于主键列、唯一索引列等值的生成</strong>。</p>
<h2 id="显式与隐式"><a href="#显式与隐式" class="headerlink" title="显式与隐式"></a>显式与隐式</h2><ul>
<li>显式 Sequence，通过 Sequence DDL 语法创建和维护，可以独立使用；通过select seq.nextval;获取序列值，seq 是具体 Sequence 的名字；</li>
<li>隐式 Sequence，在为主键定义 AUTO_INCREMENT 后，用于自动填充主键，由 DRDS 自动维护。</li>
</ul>
<blockquote>
<p>注意：仅拆分表和广播表指定了 AUTO_INCREMENT 后，DRDS 才会创建隐式的 Sequence。<br>非拆分表并不会，非拆分表的 AUTO_INCREMENT 的值由底层 RDS（MySQL）自己生成。  </p>
</blockquote>
<h2 id="三种类型"><a href="#三种类型" class="headerlink" title="三种类型"></a>三种类型</h2><h3 id="Group-Sequence（GROUP）"><a href="#Group-Sequence（GROUP）" class="headerlink" title="Group Sequence（GROUP）"></a>Group Sequence（GROUP）</h3><p>全局唯一的 Sequence，产生的值是自然数序列，但是 <strong>不保证连续和单调递增</strong>。如果未指定 Sequence 类型，DRDS <strong>默认使用</strong> Group Sequence。</p>
<h3 id="Time-based-Sequence（TIME）"><a href="#Time-based-Sequence（TIME）" class="headerlink" title="Time-based Sequence（TIME）"></a>Time-based Sequence（TIME）</h3><p>基于时间戳 + 节点编号 + 序列号组合而成的一种 Sequence，保证全局唯一和 <strong>宏观自增</strong>（产生的序列不连续）。  </p>
<h3 id="Simple-Sequence（SIMPLE）"><a href="#Simple-Sequence（SIMPLE）" class="headerlink" title="Simple Sequence（SIMPLE）"></a>Simple Sequence（SIMPLE）</h3><p>支持自定义步长、最大值和循环/非循环利用。但每产生一个值都要进行一次持久化操作，性能不好。</p>
<blockquote>
<p>大部分场景下建议选用Group Sequence<br>如果业务强依赖连续的Sequence，此时只能使用 Simple Sequence（注意性能问题）<br>对于性能要求比较高时优先考虑使用 Time-based Sequence</p>
</blockquote>
<h2 id="创建及删除显式Sequence"><a href="#创建及删除显式Sequence" class="headerlink" title="创建及删除显式Sequence"></a>创建及删除显式Sequence</h2><p>默认创建GROUP类型  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SEQUENCE seq1;</span><br></pre></td></tr></table></figure>
<p>指定GROUP类型  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE GROUP SEQUENCE seq2;</span><br></pre></td></tr></table></figure>
<p>指定TIME类型  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="type">TIME</span> SEQUENCE seq3;</span><br></pre></td></tr></table></figure>
<p>指定SIMPLE类型（起始值是 1000，步长为 2，最大值为 99999999999，增长到最大值后不继续循环）  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SIMPLE SEQUENCE seq4 <span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">1000</span> INCREMENT <span class="keyword">BY</span> <span class="number">2</span> MAXVALUE <span class="number">99999999999</span> NOCYCLE;</span><br></pre></td></tr></table></figure>
<p>删除Sequence</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> SEQUENCE seq1;</span><br></pre></td></tr></table></figure>
<p>查询Sequence</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> SEQUENCES</span><br></pre></td></tr></table></figure>
<p>取Sequence的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> seq1.NEXTVAL;</span><br><span class="line"><span class="keyword">select</span> seq1.NEXTVAL <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>
<h2 id="隐式用法"><a href="#隐式用法" class="headerlink" title="隐式用法"></a>隐式用法</h2><p>语法  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>name<span class="operator">&gt;</span> (</span><br><span class="line">   <span class="operator">&lt;</span><span class="keyword">column</span><span class="operator">&gt;</span> ... AUTO_INCREMENT [ <span class="keyword">BY</span> <span class="keyword">GROUP</span> <span class="operator">|</span> SIMPLE <span class="operator">|</span> <span class="type">TIME</span> ],</span><br><span class="line">   <span class="operator">&lt;</span><span class="keyword">column</span> definition<span class="operator">&gt;</span>,</span><br><span class="line">   ...</span><br><span class="line">) ... AUTO_INCREMENT<span class="operator">=</span><span class="operator">&lt;</span><span class="keyword">start</span> <span class="keyword">value</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>示例  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `group_seq_tbl` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB  AUTO_INCREMENT<span class="operator">=</span><span class="number">2000</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 dbpartition <span class="keyword">by</span> hash(`id`);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> group_seq_tbl (name) <span class="keyword">values</span> (<span class="string">&#x27;foobar&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> group_seq_tbl;</span><br></pre></td></tr></table></figure>
<p>查看建表语句  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE TABLE group_seq_tbl;</span><br></pre></td></tr></table></figure>
<p>修改起始值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> SEQUENCES;</span><br><span class="line"><span class="keyword">ALTER</span> SEQUENCE AUTO_SEQ_group_seq_tbl <span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">600000</span>;</span><br><span class="line"><span class="keyword">select</span> AUTO_SEQ_group_seq_tbl.nextval;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>将GRUOP类型一个Sequence的START由200000设成300000后，测试nextval时会从400000开始。<br>这不是BUG，是由GROUP特性决定的。使用SIMPLE，才可以保证连续、单调递增。  </p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201709/feign%E5%A3%B0%E6%98%8E%E5%BC%8FREST%E8%B0%83%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201709/feign%E5%A3%B0%E6%98%8E%E5%BC%8FREST%E8%B0%83%E7%94%A8/" class="post-title-link" itemprop="url">Feign-声明式REST调用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:35:01" itemprop="dateCreated datePublished" datetime="2018-11-06T15:35:01+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文主要介绍如何使用spring-cloud-feign，在项目中使用Feign进行REST调用。</p>
<p>通常我们进行微服务间的REST调用时，一般会使用restTemplate，写起来也比较方便，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResponseEntity&lt;UserDTO&gt; result &#x3D; restTemplate.getForEntity(baseurl + &quot;&#x2F;users?serialNumber&#x3D;18612341234&quot;, UserDTO.class);</span><br><span class="line"></span><br><span class="line">ResponseEntity&lt;String&gt; result &#x3D; restTemplate.exchange(baseurl +  &quot;&#x2F;users&#x2F;1715043034165359&quot;, HttpMethod.PUT, new HttpEntity(user), String.class);</span><br></pre></td></tr></table></figure>
<p>但RestTemplate这种方式的缺点是代码量略大，且不太直观。  </p>
<p>微服务强调跨语言解耦，不提倡以前那种将API部分打包并分发的方式。不同微服务间的业务代码的冗余不可避免。使用Feign，就可以简化Rest客户端这一部分的代码。</p>
<h2 id="引入pom-xml依赖"><a href="#引入pom-xml依赖" class="headerlink" title="引入pom.xml依赖"></a>引入pom.xml依赖</h2><p>Spring Boot工程中，直接引入spring-cloud-starter-feign依赖即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">  &lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">      &lt;version&gt;Dalston.SR2&lt;&#x2F;version&gt;</span><br><span class="line">      &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">      &lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">  &lt;&#x2F;dependencies&gt;</span><br><span class="line">&lt;&#x2F;dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-feign&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>
<h2 id="application-yml配置"><a href="#application-yml配置" class="headerlink" title="application.yml配置"></a>application.yml配置</h2><p>新版本的Feign默认是禁用Hystrix的，需要手工配置打开。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feign.hystrix.enabled: true</span><br></pre></td></tr></table></figure>
<p>Feign本身可以与Eureka/Ribbon比较好的配合使用，不需要其它配置，直接使用”应用名”进行调用。</p>
<p>当微服务没有使用Eureka做服务发现时，就需要手工配置Ribbon。例如，当使用marathon-lb时，可以这样配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">marathon-lb-internal.ribbon.listOfServers: marathon-lb-internal.marathon.mesos</span><br></pre></td></tr></table></figure>
<p>这里指定了一个DNS，当然也可以写死一个或多个IP。</p>
<h2 id="启用EnableFeignClients注解"><a href="#启用EnableFeignClients注解" class="headerlink" title="启用EnableFeignClients注解"></a>启用EnableFeignClients注解</h2><p>最简单的，可以在Application.java上，加上这个注解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@EnableFeignClients</span><br></pre></td></tr></table></figure>
<p>或者，新建一个配置类，指定profile：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Profile(&quot;enable-feign&quot;)</span><br><span class="line">@Configuration</span><br><span class="line">@EnableFeignClients(basePackages &#x3D; &#123;&quot;com.sitech.sdtools&quot;&#125;)</span><br><span class="line">public class FeignConfiguration &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>使用配置类+profile的好处是，可以根据不同的环境，非常方便的启用/禁用Feign。<br>特别是在单元测试时，由于mockito无法对Feign生成的Bean进行Mock，这时就可以在profile中禁用Feign，直接执行Fallback。  </p>
<blockquote>
<p>另外，需要注意一下，如果配置类的路径不是在根路径，而是在com.foo.bar.config这样的包下，需要加上”basePackages”参数。</p>
</blockquote>
<h2 id="解决Bean冲突"><a href="#解决Bean冲突" class="headerlink" title="解决Bean冲突"></a>解决Bean冲突</h2><p>我目前的Spring Clound的版本是Dalston.SR2，如果集成了Hystrix，编写Fallback类后会有Bean冲突的问题，貌似是自动生成的@Primary注解无效，具体原因没有深究，可以通过配置解决，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ConditionalOnClass(&#123;Feign.class&#125;)</span><br><span class="line">public class FeignConfiguration &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public WebMvcRegistrations feignWebRegistrations() &#123;</span><br><span class="line">        return new WebMvcRegistrationsAdapter() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public RequestMappingHandlerMapping getRequestMappingHandlerMapping() &#123;</span><br><span class="line">                return new FeignFilterRequestMappingHandlerMapping();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class FeignFilterRequestMappingHandlerMapping extends RequestMappingHandlerMapping &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected boolean isHandler(Class&lt;?&gt; beanType) &#123;</span><br><span class="line">            return super.isHandler(beanType) &amp;&amp; (AnnotationUtils.findAnnotation(beanType, FeignClient.class) &#x3D;&#x3D; null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="开启日志"><a href="#开启日志" class="headerlink" title="开启日志"></a>开启日志</h2><p>Feign的日志是DEBUG级别，在LogBack中有时需要特别配置一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;logger name&#x3D;&quot;com.foo.bar.client&quot; additivity&#x3D;&quot;false&quot; level&#x3D;&quot;debug&quot;&gt;</span><br><span class="line">  &lt;appender-ref ref&#x3D;&quot;stdout&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;logger&gt;</span><br></pre></td></tr></table></figure>

<h2 id="定义client接口"><a href="#定义client接口" class="headerlink" title="定义client接口"></a>定义client接口</h2><p>下面开始，正式进入正题，定义一个接口，并加上@FeignClient注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;marathon-lb-internal&quot;, fallback = StaticInfoClientFallback.class)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/sd/staticinfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StaticInfoClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/products/&#123;productId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProductDTO <span class="title">getProductInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Long productId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以直接在服务端的Controller层中拷贝代码，稍做修改即可，非常方便。</p>
<blockquote>
<p>但请注意：</p>
<ol>
<li><code>@PathVariable(&quot;productId&quot;)</code>，需要显示的指定对应的参数名，不能像SpringMVC一样自动对应。</li>
<li>目前只能使用<code>@RequestMapping</code>注解，而不能使用<code>@GetMapping</code>等</li>
</ol>
</blockquote>
<h2 id="编写fallback类"><a href="#编写fallback类" class="headerlink" title="编写fallback类"></a>编写fallback类</h2><p>当调用失败时，会执行fallback类中的逻辑。    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">class StaticInfoClientFallback implements StaticInfoClient &#123;</span><br><span class="line">    private static final Logger logger &#x3D; LoggerFactory.getLogger(TradeInfoClientFallback.class);</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ProductDTO getProductInfo(Long productId) &#123;</span><br><span class="line">        logger.error(&quot;StaticInfoClient.getProductInfo 执行失败&quot;);</span><br><span class="line"></span><br><span class="line">        ProductDTO dto &#x3D; new ProductDTO();</span><br><span class="line">        dto.setProductId(productId);</span><br><span class="line">        dto.setProductName(&quot;产品名称暂时无法获取&quot;);</span><br><span class="line">        return dto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意不要忘记加上<code>@Component</code></p>
</blockquote>
<h2 id="发起REST调用"><a href="#发起REST调用" class="headerlink" title="发起REST调用"></a>发起REST调用</h2><p>REST调用也非常简单，一行代码搞定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProductDTO productInfo &#x3D; staticInfoClient.getProductInfo(entity.getProductId());</span><br></pre></td></tr></table></figure>
<h2 id="END"><a href="#END" class="headerlink" title="END"></a>END</h2><p>Feign的配置略微复杂，坑也比较多，有一定的学习成本的。但带来的好处理，在使用上即优雅又方便。<br>与RestTemplate相比，只能说是各有利弊吧，可以酌情选择。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201709/%E4%BD%BF%E7%94%A8dockerfile%E6%8F%92%E4%BB%B6%E6%89%93%E5%8C%85%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%95%9C%E5%83%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201709/%E4%BD%BF%E7%94%A8dockerfile%E6%8F%92%E4%BB%B6%E6%89%93%E5%8C%85%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%95%9C%E5%83%8F/" class="post-title-link" itemprop="url">使用dockerfile插件打包微服务镜像</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:34:50" itemprop="dateCreated datePublished" datetime="2018-11-06T15:34:50+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>使用spotify的dockerfile maven插件，可以帮助我们将maven与docker进行集成，更快速的在maven构建过程中进行docker镜像的打包操作。<br>配置仍然是基于Dockerfile的，插件只是辅助。  </p>
<p>请注意，插件的名称是 <strong>spotify</strong> 的 <strong>dockerfile-maven-plugin</strong> ，而非 <strong>docker-maven-plugin</strong> 。</p>
<p>详情可访问 <a target="_blank" rel="noopener" href="https://github.com/spotify/dockerfile-maven">github页面</a></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>首先准备一个spring-boot工程，假设工程名为playground。另外本机需要安装docker，过程都不再赘述。<br>本文平台为macOS12，docker在不同平台下可能有所差异。  </p>
<p>由于dockerhub访问较慢，可以用$$先自行搭建一个socks5代理来加速访问。代理不是必须的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ALL_PROXY&#x3D;socks5:&#x2F;&#x2F;xx.xx.xx.xx:xx</span><br></pre></td></tr></table></figure>
<h2 id="建立Dockerfile"><a href="#建立Dockerfile" class="headerlink" title="建立Dockerfile"></a>建立Dockerfile</h2><p>在工程目录下新建一个Dockerfile，基于openjdk的镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8-jdk-alpine</span><br><span class="line">VOLUME &#x2F;tmp</span><br><span class="line">ADD target&#x2F;playground-1.1.0.jar app.jar</span><br><span class="line">ENV JAVA_OPTS&#x3D;&quot;&quot;</span><br><span class="line">ENTRYPOINT [ &quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -Djava.security.egd&#x3D;file:&#x2F;dev&#x2F;.&#x2F;urandom -jar &#x2F;app.jar&quot; ]</span><br></pre></td></tr></table></figure>
<h2 id="使用docker命令构建镜像"><a href="#使用docker命令构建镜像" class="headerlink" title="使用docker命令构建镜像"></a>使用docker命令构建镜像</h2><p>在使用Maven插件之前，可以试着先用docker命令来进行打包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t&#x3D;&quot;yourname&#x2F;playground:latest&quot; .</span><br></pre></td></tr></table></figure>
<p>查看镜像是否生成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p>然后可以使用<code>docker push</code>推送镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push yourname&#x2F;playground</span><br></pre></td></tr></table></figure>
<h3 id="编辑pom-xml"><a href="#编辑pom-xml" class="headerlink" title="编辑pom.xml"></a>编辑pom.xml</h3><p>测试通过后，就可以在pom.xml中添加spotify插件了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">   &lt;docker.image.prefix&gt;yourname&lt;&#x2F;docker.image.prefix&gt;</span><br><span class="line">&lt;&#x2F;properties&gt;</span><br><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;com.spotify&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;dockerfile-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.3.4&lt;&#x2F;version&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;repository&gt;$&#123;docker.image.prefix&#125;&#x2F;$&#123;project.artifactId&#125;&lt;&#x2F;repository&gt;</span><br><span class="line">            &lt;&#x2F;configuration&gt;</span><br><span class="line">        &lt;&#x2F;plugin&gt;</span><br><span class="line">    &lt;&#x2F;plugins&gt;</span><br><span class="line">&lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure>
<p>另外还可以添加一个execution，在maven的install生命周期自动进行build和push。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;executions&gt;</span><br><span class="line">	&lt;execution&gt;</span><br><span class="line">		&lt;id&gt;default&lt;&#x2F;id&gt;</span><br><span class="line">		&lt;phase&gt;install&lt;&#x2F;phase&gt;</span><br><span class="line">		&lt;goals&gt;</span><br><span class="line">			&lt;goal&gt;build&lt;&#x2F;goal&gt;</span><br><span class="line">			&lt;goal&gt;push&lt;&#x2F;goal&gt;</span><br><span class="line">		&lt;&#x2F;goals&gt;</span><br><span class="line">	&lt;&#x2F;execution&gt;</span><br><span class="line">&lt;&#x2F;executions&gt;</span><br></pre></td></tr></table></figure>
<h3 id="使用插件构建镜像"><a href="#使用插件构建镜像" class="headerlink" title="使用插件构建镜像"></a>使用插件构建镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install dockerfile:build</span><br></pre></td></tr></table></figure>
<h3 id="使用插件推送镜像"><a href="#使用插件推送镜像" class="headerlink" title="使用插件推送镜像"></a>使用插件推送镜像</h3><p>在使用dockerfile-maven-plugin推送前，需要先编辑一下<code>~/.docker/config.json</code>，添加用户名及密码，否则会报认证失败。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;auths&quot;: &#123;</span><br><span class="line">    &quot;https:&#x2F;&#x2F;index.docker.io&#x2F;v1&#x2F;&quot;: &#123;</span><br><span class="line">      &quot;Username&quot;: &quot;xxxxxx&quot;,</span><br><span class="line">      &quot;Secret&quot;: &quot;xxxxxx&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;credsStore&quot;: &quot;osxkeychain&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后直接运行即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn dockerfile:push</span><br></pre></td></tr></table></figure>
<h2 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a>运行镜像</h2><p>最后，可以使用<code>docker run</code>命令可以将镜像启动，在浏览器中查看一下运行情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:8080 -t yourname&#x2F;playground</span><br></pre></td></tr></table></figure>
<p>使用<code>docker logs</code>简单查看日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">docker logs f4d7e737f47f</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201710/ZEN-SC-SAMPLE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201710/ZEN-SC-SAMPLE/" class="post-title-link" itemprop="url">ZEN-SC-SAMPLE</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:33:44" itemprop="dateCreated datePublished" datetime="2018-11-06T15:33:44+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>ZEN-SC-SAMPLE:SpringCloud常用组件示例。</p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>更多源码，请移步GitHub:<br><a target="_blank" rel="noopener" href="https://github.com/xiiiblue/zen-sc-sample">https://github.com/xiiiblue/zen-sc-sample</a></p>
<h2 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h2><h3 id="Docker方式启动"><a href="#Docker方式启动" class="headerlink" title="Docker方式启动"></a>Docker方式启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>
<h3 id="手工方式启动"><a href="#手工方式启动" class="headerlink" title="手工方式启动"></a>手工方式启动</h3><p>添加DNS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;hosts</span><br><span class="line">127.0.0.1 zen-eureka</span><br><span class="line">127.0.0.1 zen-zipkin</span><br><span class="line">127.0.0.1 zen-config</span><br></pre></td></tr></table></figure>
<p>在每个模块下分别执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run</span><br></pre></td></tr></table></figure>
<h2 id="组件清单"><a href="#组件清单" class="headerlink" title="组件清单"></a>组件清单</h2><ul>
<li>hystrix - 服务降级与融断</li>
<li>feign - 声明式REST调用</li>
<li>eureka - 服务注册与发现</li>
<li>ribbon - 客户端负载均衡</li>
<li>config-server - 配置中心</li>
<li>zuul - API网关</li>
<li>turbine - 监控聚合</li>
<li>hystrix-dashboard - Hystrix面板</li>
<li>sleuth - 服务跟踪</li>
<li>zipkin - 调用链跟踪</li>
</ul>
<h2 id="未包含组件"><a href="#未包含组件" class="headerlink" title="未包含组件"></a>未包含组件</h2><ul>
<li>ELK</li>
</ul>
<h2 id="URLs"><a href="#URLs" class="headerlink" title="URLs"></a>URLs</h2><ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8888/application/default">ConfigServer-配置中心</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8761/">Eureka-服务注册与发现</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8080/swagger-ui.html">Playground-示例微服务</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8040/zen-playground/swagger-ui.html">Zuul-应用网关</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8031/turbine.stream">Turbine-监控聚合</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:9411/zipkin/">Zipkin-调用链跟踪</a></li>
</ul>
<h2 id="其它说明"><a href="#其它说明" class="headerlink" title="其它说明"></a>其它说明</h2><h3 id="刷新配置"><a href="#刷新配置" class="headerlink" title="刷新配置"></a>刷新配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http:&#x2F;&#x2F;localhost:8080&#x2F;refresh</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201711/12factor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201711/12factor/" class="post-title-link" itemprop="url">The Twelve-Factor App</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:32:46" itemprop="dateCreated datePublished" datetime="2018-11-06T15:32:46+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h2><p><a target="_blank" rel="noopener" href="https://12factor.net/zh_cn">https://12factor.net/zh_cn</a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>12-Factor 为构建如下的 SaaS 应用提供了方法论：<br>使用标准化流程自动配置，从而使新的开发者花费最少的学习成本加入这个项目。<br>和操作系统之间尽可能的划清界限，在各个系统中提供最大的可移植性。<br>适合部署在现代的云计算平台，从而在服务器和系统管理方面节省资源。<br>将开发环境和生产环境的差异降至最低，并使用持续交付实施敏捷开发。<br>可以在工具、架构和开发流程不发生明显变化的前提下实现扩展。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>I. 基准代码<br>一份基准代码，多份部署<br>II. 依赖<br>显式声明依赖关系<br>III. 配置<br>在环境中存储配置<br>IV. 后端服务<br>把后端服务当作附加资源<br>V. 构建，发布，运行<br>严格分离构建和运行<br>VI. 进程<br>以一个或多个无状态进程运行应用<br>VII. 端口绑定<br>通过端口绑定提供服务<br>VIII. 并发<br>通过进程模型进行扩展<br>IX. 易处理<br>快速启动和优雅终止可最大化健壮性<br>X. 开发环境与线上环境等价<br>尽可能的保持开发，预发布，线上环境相同<br>XI. 日志<br>把日志当作事件流<br>XII. 管理进程<br>后台管理任务当作一次性进程运行</p>
<p>12-factor应用本身从不考虑存储自己的输出流。 不应该试图去写或者管理日志文件。相反，每一个运行的进程都会直接的标准输出（stdout）事件流。开发环境中，开发人员可以通过这些数据流，实时在终端看到应用的活动。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://www.bluexiii.com/201803/Ubuntu%E8%BF%9E%E6%8E%A5Android%E6%89%8B%E6%9C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201803/Ubuntu%E8%BF%9E%E6%8E%A5Android%E6%89%8B%E6%9C%BA/" class="post-title-link" itemprop="url">Ubuntu连接Android手机</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-06 15:31:35" itemprop="dateCreated datePublished" datetime="2018-11-06T15:31:35+08:00">2018-11-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="解决Ubuntu无法识别Android手机的问题"><a href="#解决Ubuntu无法识别Android手机的问题" class="headerlink" title="解决Ubuntu无法识别Android手机的问题"></a>解决Ubuntu无法识别Android手机的问题</h2><ol>
<li>安装mtp相关的包：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libmtp-common mtp-tools libmtp-dev libmtp-runtime libmtp9</span><br></pre></td></tr></table></figure></li>
<li>查看手机的USB信息<br>执行：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsusb</span><br></pre></td></tr></table></figure>
记录下新增的一条USB设备的信息，以坚果Pro1为例：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Bus 002 Device 011: ID 29a9:7020  </span><br></pre></td></tr></table></figure></li>
<li>编辑69-libmtp.rules<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi &#x2F;lib&#x2F;udev&#x2F;rules.d&#x2F;69-libmtp.rules</span><br></pre></td></tr></table></figure>
新增一行：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ATTR&#123;idVendor&#125;&#x3D;&#x3D;&quot;29a9&quot;, ATTR&#123;idProduct&#125;&#x3D;&#x3D;&quot;7020&quot;, SYMLINK+&#x3D;&quot;libmtp-%k&quot;, ENV&#123;ID_MTP_DEVICE&#125;&#x3D;&quot;1&quot;, ENV&#123;ID_MEDIA_PLAYER&#125;&#x3D;&quot;1&quot;</span><br></pre></td></tr></table></figure>
注意替换掉其中的idVendor和idProduct</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/24/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><span class="page-number current">25</span><a class="page-number" href="/page/26/">26</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/26/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">BlueXIII</p>
  <div class="site-description" itemprop="description">IT技术类文章、笔记分享</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">273</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xiiiblue" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiiiblue" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/bluexiii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;bluexiii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18050487号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BlueXIII</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
