<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.bluexiii.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="IT技术类文章、笔记分享">
<meta property="og:type" content="website">
<meta property="og:title" content="BlueXIII&#39;s Blog">
<meta property="og:url" content="http://blog.bluexiii.com/page/18/index.html">
<meta property="og:site_name" content="BlueXIII&#39;s Blog">
<meta property="og:description" content="IT技术类文章、笔记分享">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="BlueXIII">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://blog.bluexiii.com/page/18/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>BlueXIII's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BlueXIII's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">热爱技术,持续学习</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201709/feign%E5%A3%B0%E6%98%8E%E5%BC%8FREST%E8%B0%83%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201709/feign%E5%A3%B0%E6%98%8E%E5%BC%8FREST%E8%B0%83%E7%94%A8/" class="post-title-link" itemprop="url">Feign-声明式REST调用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-16 09:53:43" itemprop="dateCreated datePublished" datetime="2017-09-16T09:53:43+08:00">2017-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-06 15:35:01" itemprop="dateModified" datetime="2018-11-06T15:35:01+08:00">2018-11-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文主要介绍如何使用spring-cloud-feign，在项目中使用Feign进行REST调用。</p>
<p>通常我们进行微服务间的REST调用时，一般会使用restTemplate，写起来也比较方便，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResponseEntity&lt;UserDTO&gt; result &#x3D; restTemplate.getForEntity(baseurl + &quot;&#x2F;users?serialNumber&#x3D;18612341234&quot;, UserDTO.class);</span><br><span class="line"></span><br><span class="line">ResponseEntity&lt;String&gt; result &#x3D; restTemplate.exchange(baseurl +  &quot;&#x2F;users&#x2F;1715043034165359&quot;, HttpMethod.PUT, new HttpEntity(user), String.class);</span><br></pre></td></tr></table></figure>
<p>但RestTemplate这种方式的缺点是代码量略大，且不太直观。  </p>
<p>微服务强调跨语言解耦，不提倡以前那种将API部分打包并分发的方式。不同微服务间的业务代码的冗余不可避免。使用Feign，就可以简化Rest客户端这一部分的代码。</p>
<h2 id="引入pom-xml依赖"><a href="#引入pom-xml依赖" class="headerlink" title="引入pom.xml依赖"></a>引入pom.xml依赖</h2><p>Spring Boot工程中，直接引入spring-cloud-starter-feign依赖即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">  &lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-cloud-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">      &lt;version&gt;Dalston.SR2&lt;&#x2F;version&gt;</span><br><span class="line">      &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">      &lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">  &lt;&#x2F;dependencies&gt;</span><br><span class="line">&lt;&#x2F;dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-feign&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>
<h2 id="application-yml配置"><a href="#application-yml配置" class="headerlink" title="application.yml配置"></a>application.yml配置</h2><p>新版本的Feign默认是禁用Hystrix的，需要手工配置打开。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feign.hystrix.enabled: true</span><br></pre></td></tr></table></figure>
<p>Feign本身可以与Eureka/Ribbon比较好的配合使用，不需要其它配置，直接使用”应用名”进行调用。</p>
<p>当微服务没有使用Eureka做服务发现时，就需要手工配置Ribbon。例如，当使用marathon-lb时，可以这样配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">marathon-lb-internal.ribbon.listOfServers: marathon-lb-internal.marathon.mesos</span><br></pre></td></tr></table></figure>
<p>这里指定了一个DNS，当然也可以写死一个或多个IP。</p>
<h2 id="启用EnableFeignClients注解"><a href="#启用EnableFeignClients注解" class="headerlink" title="启用EnableFeignClients注解"></a>启用EnableFeignClients注解</h2><p>最简单的，可以在Application.java上，加上这个注解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@EnableFeignClients</span><br></pre></td></tr></table></figure>
<p>或者，新建一个配置类，指定profile：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Profile(&quot;enable-feign&quot;)</span><br><span class="line">@Configuration</span><br><span class="line">@EnableFeignClients(basePackages &#x3D; &#123;&quot;com.sitech.sdtools&quot;&#125;)</span><br><span class="line">public class FeignConfiguration &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>使用配置类+profile的好处是，可以根据不同的环境，非常方便的启用/禁用Feign。<br>特别是在单元测试时，由于mockito无法对Feign生成的Bean进行Mock，这时就可以在profile中禁用Feign，直接执行Fallback。  </p>
<blockquote>
<p>另外，需要注意一下，如果配置类的路径不是在根路径，而是在com.foo.bar.config这样的包下，需要加上”basePackages”参数。</p>
</blockquote>
<h2 id="解决Bean冲突"><a href="#解决Bean冲突" class="headerlink" title="解决Bean冲突"></a>解决Bean冲突</h2><p>我目前的Spring Clound的版本是Dalston.SR2，如果集成了Hystrix，编写Fallback类后会有Bean冲突的问题，貌似是自动生成的@Primary注解无效，具体原因没有深究，可以通过配置解决，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ConditionalOnClass(&#123;Feign.class&#125;)</span><br><span class="line">public class FeignConfiguration &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public WebMvcRegistrations feignWebRegistrations() &#123;</span><br><span class="line">        return new WebMvcRegistrationsAdapter() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public RequestMappingHandlerMapping getRequestMappingHandlerMapping() &#123;</span><br><span class="line">                return new FeignFilterRequestMappingHandlerMapping();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class FeignFilterRequestMappingHandlerMapping extends RequestMappingHandlerMapping &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected boolean isHandler(Class&lt;?&gt; beanType) &#123;</span><br><span class="line">            return super.isHandler(beanType) &amp;&amp; (AnnotationUtils.findAnnotation(beanType, FeignClient.class) &#x3D;&#x3D; null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="开启日志"><a href="#开启日志" class="headerlink" title="开启日志"></a>开启日志</h2><p>Feign的日志是DEBUG级别，在LogBack中有时需要特别配置一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;logger name&#x3D;&quot;com.foo.bar.client&quot; additivity&#x3D;&quot;false&quot; level&#x3D;&quot;debug&quot;&gt;</span><br><span class="line">  &lt;appender-ref ref&#x3D;&quot;stdout&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;logger&gt;</span><br></pre></td></tr></table></figure>

<h2 id="定义client接口"><a href="#定义client接口" class="headerlink" title="定义client接口"></a>定义client接口</h2><p>下面开始，正式进入正题，定义一个接口，并加上@FeignClient注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;marathon-lb-internal&quot;, fallback = StaticInfoClientFallback.class)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/sd/staticinfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StaticInfoClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/products/&#123;productId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProductDTO <span class="title">getProductInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Long productId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以直接在服务端的Controller层中拷贝代码，稍做修改即可，非常方便。</p>
<blockquote>
<p>但请注意：</p>
<ol>
<li><code>@PathVariable(&quot;productId&quot;)</code>，需要显示的指定对应的参数名，不能像SpringMVC一样自动对应。</li>
<li>目前只能使用<code>@RequestMapping</code>注解，而不能使用<code>@GetMapping</code>等</li>
</ol>
</blockquote>
<h2 id="编写fallback类"><a href="#编写fallback类" class="headerlink" title="编写fallback类"></a>编写fallback类</h2><p>当调用失败时，会执行fallback类中的逻辑。    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">class StaticInfoClientFallback implements StaticInfoClient &#123;</span><br><span class="line">    private static final Logger logger &#x3D; LoggerFactory.getLogger(TradeInfoClientFallback.class);</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ProductDTO getProductInfo(Long productId) &#123;</span><br><span class="line">        logger.error(&quot;StaticInfoClient.getProductInfo 执行失败&quot;);</span><br><span class="line"></span><br><span class="line">        ProductDTO dto &#x3D; new ProductDTO();</span><br><span class="line">        dto.setProductId(productId);</span><br><span class="line">        dto.setProductName(&quot;产品名称暂时无法获取&quot;);</span><br><span class="line">        return dto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意不要忘记加上<code>@Component</code></p>
</blockquote>
<h2 id="发起REST调用"><a href="#发起REST调用" class="headerlink" title="发起REST调用"></a>发起REST调用</h2><p>REST调用也非常简单，一行代码搞定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProductDTO productInfo &#x3D; staticInfoClient.getProductInfo(entity.getProductId());</span><br></pre></td></tr></table></figure>
<h2 id="END"><a href="#END" class="headerlink" title="END"></a>END</h2><p>Feign的配置略微复杂，坑也比较多，有一定的学习成本的。但带来的好处理，在使用上即优雅又方便。<br>与RestTemplate相比，只能说是各有利弊吧，可以酌情选择。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201709/%E5%85%B3%E4%BA%8EFeign%E7%9A%84Fallback%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201709/%E5%85%B3%E4%BA%8EFeign%E7%9A%84Fallback%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">关于Feign的Fallback处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-16 09:51:24" itemprop="dateCreated datePublished" datetime="2017-09-16T09:51:24+08:00">2017-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-26 09:44:33" itemprop="dateModified" datetime="2021-01-26T09:44:33+08:00">2021-01-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Feign的不恰当的fallback"><a href="#Feign的不恰当的fallback" class="headerlink" title="Feign的不恰当的fallback"></a>Feign的不恰当的fallback</h2><p>Feign的坑不少，特别与Hystrix集成之后。<br>在微服务引入Feign后，上线不久后便发现，对于一个简单的查询类调用，在下游返回正常的”404-资源不存在”这种业务异常时，Feign也做了fallback，最终导致circuit break，引发平台告警。</p>
<h2 id="REST接口的设计"><a href="#REST接口的设计" class="headerlink" title="REST接口的设计"></a>REST接口的设计</h2><p>为了解释这个问题，首先还是要从REST接口开始谈起。</p>
<p>REST的一个缺点（也有人认为是优势），它只是一种依赖于HTTP的”风格”，而没有明确的”规范”，所以客户端和服务端之间，要自行达成某种”约定”。<br>例如返回码，就要硬往HTTP STATUS上靠。</p>
<p>关于返回码，公认的”最佳实践”大概是这样的：</p>
<ol>
<li>如果业务处理成功，http status返回200、204等。如果有内容，BODY中直接返回内容（对象或数组都可以），不再有RPC时代的code/message这样的状态描述。如果没有内容，BODY直接空白，No News Is Good News。</li>
<li>如果业务处理失败，业务逻辑导致的，则http status返回4XX，BODY中返回报错信息，报错信息的统一格式大概是这样的：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;: 409,  &#x2F;&#x2F; 冗余字段，把http status再重复一遍</span><br><span class="line">  &quot;code&quot;: 888,  &#x2F;&#x2F; 自定义的错误码</span><br><span class="line">  &quot;message&quot;: &quot;foobar&quot;  &#x2F;&#x2F; 错误描述</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>如果是其它未知错误，抛5XX，认为是服务器内部错误，而不是逻辑错误。</li>
</ol>
<p>所以对于APP/WEB等客户端来说，很简单，如果发现2XX，则认为成功，直接获取数据。如果非2XX，则是失败，直接取code和message，展现到前台。</p>
<p>但是对于微服务之间的调用，就要区分是”4XX-业务逻辑异常”，还是”5XX-服务器异常”了。。。</p>
<h2 id="REST返回码的选择"><a href="#REST返回码的选择" class="headerlink" title="REST返回码的选择"></a>REST返回码的选择</h2><p>下面详细讲一下HTTP STATUS的选择问题。</p>
<p>关于HTTP返回码，看了很多参考（论战），”大概”可以这样选择：</p>
<p>成功： 2XX系列  </p>
<ul>
<li>200 OK  // 查询、删除成功用这个</li>
<li>201 CREATED  // 新增、修改时用这个。且返回BODY中无任何信息。</li>
</ul>
<p>业务异常： 4XX系列  </p>
<ul>
<li>400 BAD_REQUEST  // 现在有很多人在业务异常时抛这个错。但400要慎重使用。稍后解释。</li>
<li>404 NOT_FOUND  // 查询不到结果时用这个</li>
<li>403 FORBIDDEN  // 这个也慎重使用。</li>
<li>409 CONFLICT   // 业务异常时，可以用这个。</li>
</ul>
<p>主机异常：5XX系列  </p>
<ul>
<li>500 INTERNAL_SERVER_ERROR // 对于未知异常，统一用这个了</li>
<li>503 SERVICE_UNAVAILABLE  // Hystrix异常用这个</li>
</ul>
<h2 id="什么时候应该Fallback"><a href="#什么时候应该Fallback" class="headerlink" title="什么时候应该Fallback"></a>什么时候应该Fallback</h2><p>2XX，成功，这个不用再讨论。<br>5XX，也相当明确，直接Fallback，这个也不用讨论。<br>4XX，可以一律认为是业务逻辑异常（或者更精确的说，可以认为4XX中的某几个是业务异常）。这时候，应该是用if/else来处理这个异常，而不应该动用Hystrix来Fallback。  </p>
<p>Feign在默认情况下，对于非2XX，都认为是异常。这个地方是有问题的。特别是对于404这种非常容易抛出的业务异常来说，没两下就circuit break了。</p>
<p>Feign的Issue里已经有人提过这个问题，后面的版本中已经提供了一个参数:<code>decode404</code>。</p>
<p>可以看一下Feign的代码，位置在：<br>~/.m2/repository/io/github/openfeign/feign-core/9.5.0/feign-core-9.5.0.jar!/feign/SynchronousMethodHandler.class<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/sgqvj.jpg"></p>
<p>所以在Client上可以这样设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(name &#x3D; &quot;marathon-lb&quot;, fallback &#x3D; FooBarClientFallback.class, decode404 &#x3D; true)</span><br><span class="line">@RequestMapping(value &#x3D; &quot;&#x2F;foo&#x2F;bar&quot;)</span><br><span class="line">public interface FooBarClient &#123;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只需要加入<code>decode404 = true</code>这一个参数，Feign对于2XX和404 ，都不会走Fallback了。<br>排除404，已经基本上够用了，如果想把409、400等status也加到例外中，可以重写一下Feign的errorDecoder。</p>
<h2 id="关于4XX错误"><a href="#关于4XX错误" class="headerlink" title="关于4XX错误"></a>关于4XX错误</h2><p>刚才提到的，如果把2XX，另外加上4XX，全部认为是正常业务逻辑，都不走Fallback，可不可行？ 我想最好不要这样很笼统的设置，要看情况。</p>
<p>因为http status不全是服务端给出的，如果服务端与消费者之间隔着一些Nginx、HA、Kong这样的网关，那么情况可能就复杂了，网关也有可能抛出status。</p>
<p>例如当某个微服务宕机之后，Kong网关会直接返回400，这种情况下，很明显是应当Fallback的。</p>
<p>所以，在定义错误码时，要尽量避开400、403这种很溃常见的码，像409这样小众的，差不多可以放心使用。<br>这样，调用方就可以有针对性的对某几个4XX的status进行单独配置，配置为业务异常。  </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201611/Docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201611/Docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Docker学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-05 15:14:48" itemprop="dateCreated datePublished" datetime="2017-09-05T15:14:48+08:00">2017-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-06 15:50:37" itemprop="dateModified" datetime="2018-11-06T15:50:37+08:00">2018-11-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><h2 id="docker-for-mac"><a href="#docker-for-mac" class="headerlink" title="docker for mac"></a>docker for mac</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/docker-for-mac/">https://docs.docker.com/docker-for-mac/</a><br>HyperKit VM</p>
<h2 id="helloworld"><a href="#helloworld" class="headerlink" title="helloworld"></a>helloworld</h2><p>docker –version<br>docker-compose –version<br>docker-machine –version<br>docker ps<br>docker run hello-world<br>docker run -d -p 80:80 –name webserver nginx<br>docker run -it ubuntu bash<br>docker run docker/whalesay cowsay boo<br>docker run docker/whalesay cowsay boo-boo</p>
<h2 id="build-image"><a href="#build-image" class="headerlink" title="build image"></a>build image</h2><p>vi Dockerfile<br>FROM docker/whalesay:latest<br>RUN apt-get -y update &amp;&amp; apt-get install -y fortunes<br>CMD /usr/games/fortune -a | cowsay</p>
<p>docker build -t docker-whale .<br>docker images<br>docker run docker-whale</p>
<h2 id="tag-amp-push"><a href="#tag-amp-push" class="headerlink" title="tag &amp; push"></a>tag &amp; push</h2><p>docker tag 038cc8845778 bluexiii/docker-whale:latest<br>docker login<br>docker push maryatdocker/docker-whale<br>docker rmi -f docker-whale<br>docker run bluexiii/docker-whale</p>
<h2 id="容器命名"><a href="#容器命名" class="headerlink" title="容器命名"></a>容器命名</h2><p>docker run –name bob_the_container -i -t ubuntu /bin/bash</p>
<h2 id="重新启动已停止的容器"><a href="#重新启动已停止的容器" class="headerlink" title="重新启动已停止的容器"></a>重新启动已停止的容器</h2><p>docker start bob_the_container</p>
<h2 id="附着到容器上"><a href="#附着到容器上" class="headerlink" title="附着到容器上"></a>附着到容器上</h2><p>docker attach bob_the_container</p>
<h2 id="创建守护式容器"><a href="#创建守护式容器" class="headerlink" title="创建守护式容器"></a>创建守护式容器</h2><p>docker run –name daemon_dave -d ubuntu /bin/sh -c “while true; do echo hello world; sleep 1;done”</p>
<h2 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h2><p>docker logs -ft daemon_dave</p>
<h2 id="查看容器中的进程"><a href="#查看容器中的进程" class="headerlink" title="查看容器中的进程"></a>查看容器中的进程</h2><p>docker top daemon_dave</p>
<h2 id="查看统计信息"><a href="#查看统计信息" class="headerlink" title="查看统计信息"></a>查看统计信息</h2><p>docker stats daemon_dave</p>
<h2 id="停止守护式容器"><a href="#停止守护式容器" class="headerlink" title="停止守护式容器"></a>停止守护式容器</h2><p>docker stop daemon_dave</p>
<h2 id="自动重启容器"><a href="#自动重启容器" class="headerlink" title="自动重启容器"></a>自动重启容器</h2><p>–restart=always<br>–restart=on-failure:5<br>docker run –restart=always –name daemon_dave2 -d ubuntu /bin/sh -c “while true; do echo hello world; sleep 1;done”</p>
<h2 id="获取容器详情"><a href="#获取容器详情" class="headerlink" title="获取容器详情"></a>获取容器详情</h2><p>docker inspect daemon_dave2</p>
<h2 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h2><p>docker rm</p>
<h2 id="删除所有容器"><a href="#删除所有容器" class="headerlink" title="删除所有容器"></a>删除所有容器</h2><p>docker rm <code>docker ps -a -q</code></p>
<h2 id="本地镜像位置"><a href="#本地镜像位置" class="headerlink" title="本地镜像位置"></a>本地镜像位置</h2><p>$HOME/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2</p>
<h2 id="拉取镜像到本机"><a href="#拉取镜像到本机" class="headerlink" title="拉取镜像到本机"></a>拉取镜像到本机</h2><p>docker pull fedora</p>
<h2 id="查找镜像"><a href="#查找镜像" class="headerlink" title="查找镜像"></a>查找镜像</h2><p>docker search fedora</p>
<h1 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h1><h2 id="使用commit构建镜像"><a href="#使用commit构建镜像" class="headerlink" title="使用commit构建镜像"></a>使用commit构建镜像</h2><h3 id="基于Ubuntu构建"><a href="#基于Ubuntu构建" class="headerlink" title="基于Ubuntu构建"></a>基于Ubuntu构建</h3><p>docker run -i -t ubuntu /bin/bash</p>
<h3 id="内网环境下设置apt代理"><a href="#内网环境下设置apt代理" class="headerlink" title="内网环境下设置apt代理"></a>内网环境下设置apt代理</h3><p>cat &gt; /etc/apt/apt.conf.d/10proxy<br>Acquire::http::Proxy “<a target="_blank" rel="noopener" href="http://134.32.32.13:31315/&quot;">http://134.32.32.13:31315/&quot;</a>;<br>^d</p>
<h3 id="安装基础包"><a href="#安装基础包" class="headerlink" title="安装基础包"></a>安装基础包</h3><p>apt update<br>apt install nginx</p>
<h3 id="commit提交"><a href="#commit提交" class="headerlink" title="commit提交"></a>commit提交</h3><p>docker commit cb051b49a4cd bluexiii/mynginx<br>or<br>docker commit -m ‘message’ -a ‘author’ cb051b49a4cd bluexiii/mynginx:tag<br>类似git，只提交差异部分，速度很快</p>
<p>docker inspect bluexiii/mynginx</p>
<h2 id="使用Dockfile构建镜像"><a href="#使用Dockfile构建镜像" class="headerlink" title="使用Dockfile构建镜像"></a>使用Dockfile构建镜像</h2><p>vi Dockerfile<br>FROM ubuntu<br>RUN echo ‘Acquire::http::Proxy “<a href="http://IP:PORT/&quot;;&#39;">http://IP:PORT/&quot;;&#39;</a> &gt; /etc/apt/apt.conf.d/10proxy<br>RUN apt-get -y update &amp;&amp; apt-get install -y nginx<br>RUN echo ‘hello world’ &gt;  /usr/share/nginx/html/index.html<br>EXPOSE 80<br>docker build -t bluexiii/mynginx2 .</p>
<h2 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a>运行镜像</h2><p>docker run -d -p 40080:80 –name mynginx2  bluexiii/mynginx2 nginx -g “daemon off;”</p>
<h2 id="查看端口映射情况"><a href="#查看端口映射情况" class="headerlink" title="查看端口映射情况"></a>查看端口映射情况</h2><p>docker port mynginx2 80</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%E4%BD%BF%E7%94%A8%E9%99%90%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%E4%BD%BF%E7%94%A8%E9%99%90%E5%88%B6/" class="post-title-link" itemprop="url">阿里云DRDS使用限制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-31 19:22:06" itemprop="dateCreated datePublished" datetime="2017-07-31T19:22:06+08:00">2017-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-06 15:36:05" itemprop="dateModified" datetime="2018-11-06T15:36:05+08:00">2018-11-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>以下大部分内容非原创，整理自阿里云官方文档</p>
</blockquote>
<h2 id="SQL大类限制"><a href="#SQL大类限制" class="headerlink" title="SQL大类限制"></a>SQL大类限制</h2><ul>
<li>暂不支持用户自定义数据类型、自定义函数。</li>
<li>暂不支持视图、存储过程、触发器、游标。</li>
<li>暂不支持 BEGIN…END、LOOP…END LOOP、REPEAT…UNTIL…END REPEAT、WHILE…DO…END WHILE 等复合语句。</li>
<li>暂不支类似 IF ，WHILE 等流程控制类语句。</li>
</ul>
<h2 id="DDL限制"><a href="#DDL限制" class="headerlink" title="DDL限制"></a>DDL限制</h2><ul>
<li>CREATE TABLE tbl_name LIKE old_tbl_name 不支持拆分表。</li>
<li>CREATE TABLE tbl_name SELECT statement 不支持拆分表。</li>
</ul>
<h2 id="数据库管理限制"><a href="#数据库管理限制" class="headerlink" title="数据库管理限制"></a>数据库管理限制</h2><ul>
<li>SHOW WARNINGS Syntax 不支持 LIMIT/COUNT 的组合。</li>
<li>SHOW ERRORS Syntax 不支持 LIMIT/COUNT 的组合。</li>
</ul>
<h2 id="DML限制"><a href="#DML限制" class="headerlink" title="DML限制"></a>DML限制</h2><ul>
<li>暂不支持 SELECT INTO OUTFILE/INTO DUMPFILE/INTO var_name。</li>
<li>暂不支持 INSERT DELAYED Syntax。</li>
<li>暂不支持非 WHERE 条件的 Correlate Subquery。</li>
<li>暂不支持 SQL 中带聚合条件的 Correlate Subquery。</li>
<li>暂不支持 SQL 中对于变量的引用和操作，比如 SET @c=1, @d=@c+1; SELECT @c, @d。</li>
</ul>
<blockquote>
<p>关于 Correlated Subquery 的解释：<br>Correlated Subquery is a sub-query that uses values from the outer query. In this case the inner query has to be executed for every row of outer query.<br>See example here <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Correlated_subquery">http://en.wikipedia.org/wiki/Correlated_subquery</a><br>Simple subquery doesn’t use values from the outer query and is being calculated only once:  </p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id, first_name</span><br><span class="line"><span class="keyword">FROM</span> student_details</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> student_id</span><br><span class="line"><span class="keyword">FROM</span> student_subjects</span><br><span class="line"><span class="keyword">WHERE</span> subject<span class="operator">=</span> <span class="string">&#x27;Science&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>DDL限制、数据库管理限制，由于与应用关系不大，编码时无须特别关心。<br>SQL大类限制，如视图、存储过程、触发器、游标等，通常是不被提倡的坏味道，如果有的话，直接改方式实现即可。<br>DML限制，需要特别注意。如果使用ORM，应该不会有太大问题，但用jdbcTemplate写原生SQL的话（如实时报表类的功能点）有可能会踩坑。<br>另外默认不支持跨实例事务，私有云貌似也没有GTS选项，需要在代码层面进行优化。</p>
<h2 id="DML错误示例"><a href="#DML错误示例" class="headerlink" title="DML错误示例"></a>DML错误示例</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> id,name <span class="keyword">from</span> normal_tables) t</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[b8040ac9f401000][192.168.2.47:3306][dev_sc_dmanage]ERR-CODE: [TDDL-4007][ERR_CANNOT_FETCH_TABLE_META] Table ‘normal_tables’ metadata cannot be fetched because Table ‘dev_sc_dmanage_ssiu_0000.normal_tables’ doesn’t exist. More: [<a target="_blank" rel="noopener" href="http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4007%5D">http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4007]</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a,<span class="operator">*</span>,b.<span class="operator">*</span> <span class="keyword">from</span> shard_table a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> id,name <span class="keyword">from</span> normal_table) b <span class="keyword">on</span> b.id<span class="operator">=</span>a.id;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[b80405010801000][192.168.2.47:3306][dev_sc_dmanage]column: a is not existed in either null or select clause</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a,<span class="operator">*</span>,b.<span class="operator">*</span> <span class="keyword">from</span> normal_tables a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> id,name <span class="keyword">from</span> shard_table) b <span class="keyword">on</span> b.id<span class="operator">=</span>a.id;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[b8040692c001000][192.168.2.47:3306][dev_sc_dmanage]ERR-CODE: [TDDL-4007][ERR_CANNOT_FETCH_TABLE_META] Table ‘normal_tables’ metadata cannot be fetched because Table ‘dev_sc_dmanage_ssiu_0000.normal_tables’ doesn’t exist. More: [<a target="_blank" rel="noopener" href="http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4007%5D">http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4007]</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> group_seq_tbl (name) <span class="keyword">values</span> (<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> group_seq_tbl (name) <span class="keyword">values</span> (<span class="string">&#x27;hello&#x27;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[b807dfe12c01000-24][192.168.2.47:3306][dev_sc_dmanage]ERR-CODE: [TDDL-4603][ERR_ACCROSS_DB_TRANSACTION] Transaction accross db is not supported in current transaction policy, transaction node is: DEV_SC_DMANAGE_1501040729564NYQSDEV_SC_DMANAGE_SSIU_0003_RDS, but this sql execute on: DEV_SC_DMANAGE_1501040729564NYQSDEV_SC_DMANAGE_SSIU_0006_RDS. More: [<a target="_blank" rel="noopener" href="http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4603%5D">http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4603]</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%20Sequence/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%20Sequence/" class="post-title-link" itemprop="url">阿里云DRDS Sequence</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-31 19:19:10" itemprop="dateCreated datePublished" datetime="2017-07-31T19:19:10+08:00">2017-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-06 15:35:55" itemprop="dateModified" datetime="2018-11-06T15:35:55+08:00">2018-11-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>以下大部分内容非原创，整理自阿里云官方文档</p>
</blockquote>
<h2 id="DRDS-Sequence简介"><a href="#DRDS-Sequence简介" class="headerlink" title="DRDS Sequence简介"></a>DRDS Sequence简介</h2><p>DRDS 全局唯一数字序列（64 位数字，对应 MySQL 中 Signed BIGINT 类型）的主要目标是为了生成全局唯一和有序递增的数字序列，<strong>常用于主键列、唯一索引列等值的生成</strong>。</p>
<h2 id="显式与隐式"><a href="#显式与隐式" class="headerlink" title="显式与隐式"></a>显式与隐式</h2><ul>
<li>显式 Sequence，通过 Sequence DDL 语法创建和维护，可以独立使用；通过select seq.nextval;获取序列值，seq 是具体 Sequence 的名字；</li>
<li>隐式 Sequence，在为主键定义 AUTO_INCREMENT 后，用于自动填充主键，由 DRDS 自动维护。</li>
</ul>
<blockquote>
<p>注意：仅拆分表和广播表指定了 AUTO_INCREMENT 后，DRDS 才会创建隐式的 Sequence。<br>非拆分表并不会，非拆分表的 AUTO_INCREMENT 的值由底层 RDS（MySQL）自己生成。  </p>
</blockquote>
<h2 id="三种类型"><a href="#三种类型" class="headerlink" title="三种类型"></a>三种类型</h2><h3 id="Group-Sequence（GROUP）"><a href="#Group-Sequence（GROUP）" class="headerlink" title="Group Sequence（GROUP）"></a>Group Sequence（GROUP）</h3><p>全局唯一的 Sequence，产生的值是自然数序列，但是 <strong>不保证连续和单调递增</strong>。如果未指定 Sequence 类型，DRDS <strong>默认使用</strong> Group Sequence。</p>
<h3 id="Time-based-Sequence（TIME）"><a href="#Time-based-Sequence（TIME）" class="headerlink" title="Time-based Sequence（TIME）"></a>Time-based Sequence（TIME）</h3><p>基于时间戳 + 节点编号 + 序列号组合而成的一种 Sequence，保证全局唯一和 <strong>宏观自增</strong>（产生的序列不连续）。  </p>
<h3 id="Simple-Sequence（SIMPLE）"><a href="#Simple-Sequence（SIMPLE）" class="headerlink" title="Simple Sequence（SIMPLE）"></a>Simple Sequence（SIMPLE）</h3><p>支持自定义步长、最大值和循环/非循环利用。但每产生一个值都要进行一次持久化操作，性能不好。</p>
<blockquote>
<p>大部分场景下建议选用Group Sequence<br>如果业务强依赖连续的Sequence，此时只能使用 Simple Sequence（注意性能问题）<br>对于性能要求比较高时优先考虑使用 Time-based Sequence</p>
</blockquote>
<h2 id="创建及删除显式Sequence"><a href="#创建及删除显式Sequence" class="headerlink" title="创建及删除显式Sequence"></a>创建及删除显式Sequence</h2><p>默认创建GROUP类型  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SEQUENCE seq1;</span><br></pre></td></tr></table></figure>
<p>指定GROUP类型  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE GROUP SEQUENCE seq2;</span><br></pre></td></tr></table></figure>
<p>指定TIME类型  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="type">TIME</span> SEQUENCE seq3;</span><br></pre></td></tr></table></figure>
<p>指定SIMPLE类型（起始值是 1000，步长为 2，最大值为 99999999999，增长到最大值后不继续循环）  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SIMPLE SEQUENCE seq4 <span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">1000</span> INCREMENT <span class="keyword">BY</span> <span class="number">2</span> MAXVALUE <span class="number">99999999999</span> NOCYCLE;</span><br></pre></td></tr></table></figure>
<p>删除Sequence</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> SEQUENCE seq1;</span><br></pre></td></tr></table></figure>
<p>查询Sequence</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> SEQUENCES</span><br></pre></td></tr></table></figure>
<p>取Sequence的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> seq1.NEXTVAL;</span><br><span class="line"><span class="keyword">select</span> seq1.NEXTVAL <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>
<h2 id="隐式用法"><a href="#隐式用法" class="headerlink" title="隐式用法"></a>隐式用法</h2><p>语法  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>name<span class="operator">&gt;</span> (</span><br><span class="line">   <span class="operator">&lt;</span><span class="keyword">column</span><span class="operator">&gt;</span> ... AUTO_INCREMENT [ <span class="keyword">BY</span> <span class="keyword">GROUP</span> <span class="operator">|</span> SIMPLE <span class="operator">|</span> <span class="type">TIME</span> ],</span><br><span class="line">   <span class="operator">&lt;</span><span class="keyword">column</span> definition<span class="operator">&gt;</span>,</span><br><span class="line">   ...</span><br><span class="line">) ... AUTO_INCREMENT<span class="operator">=</span><span class="operator">&lt;</span><span class="keyword">start</span> <span class="keyword">value</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>示例  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `group_seq_tbl` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB  AUTO_INCREMENT<span class="operator">=</span><span class="number">2000</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 dbpartition <span class="keyword">by</span> hash(`id`);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> group_seq_tbl (name) <span class="keyword">values</span> (<span class="string">&#x27;foobar&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> group_seq_tbl;</span><br></pre></td></tr></table></figure>
<p>查看建表语句  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE TABLE group_seq_tbl;</span><br></pre></td></tr></table></figure>
<p>修改起始值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> SEQUENCES;</span><br><span class="line"><span class="keyword">ALTER</span> SEQUENCE AUTO_SEQ_group_seq_tbl <span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">600000</span>;</span><br><span class="line"><span class="keyword">select</span> AUTO_SEQ_group_seq_tbl.nextval;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>将GRUOP类型一个Sequence的START由200000设成300000后，测试nextval时会从400000开始。<br>这不是BUG，是由GROUP特性决定的。使用SIMPLE，才可以保证连续、单调递增。  </p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%98%BF%E9%87%8C%E4%BA%91DRDS%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">阿里云DRDS分库分表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-31 18:55:16" itemprop="dateCreated datePublished" datetime="2017-07-31T18:55:16+08:00">2017-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-06 15:36:19" itemprop="dateModified" datetime="2018-11-06T15:36:19+08:00">2018-11-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>以下大部分内容非原创，整理自阿里云官方文档</p>
</blockquote>
<h2 id="单库单表"><a href="#单库单表" class="headerlink" title="单库单表"></a>单库单表</h2><p>建一张单库单表，不做任何拆分。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> single_tbl(</span><br><span class="line">  id <span class="type">int</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">  <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> single_tbl;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> normal_table(</span><br><span class="line">id <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line"><span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
<h2 id="分库不分表"><a href="#分库不分表" class="headerlink" title="分库不分表"></a>分库不分表</h2><p>假设已经建好的分库数为 8，建一张表，只分库不分表，分库方式为根据 id 列哈希。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> multi_db_single_tbl(</span><br><span class="line">  id <span class="type">int</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">  <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) dbpartition <span class="keyword">by</span> hash(id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> multi_db_single_tbl;</span><br></pre></td></tr></table></figure>
<h2 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h2><h3 id="使用哈希函数做拆分"><a href="#使用哈希函数做拆分" class="headerlink" title="使用哈希函数做拆分"></a>使用哈希函数做拆分</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> multi_db_multi_tbl(</span><br><span class="line">  id <span class="type">int</span> auto_increment,</span><br><span class="line">  bid <span class="type">int</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">  <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) dbpartition <span class="keyword">by</span> hash(id) tbpartition <span class="keyword">by</span> hash(bid) tbpartitions <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> multi_db_multi_tbl;</span><br></pre></td></tr></table></figure>
<h3 id="使用双字段哈希函数做拆分"><a href="#使用双字段哈希函数做拆分" class="headerlink" title="使用双字段哈希函数做拆分"></a>使用双字段哈希函数做拆分</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_order_tb (  </span><br><span class="line">          id <span class="type">int</span>,</span><br><span class="line">          seller_id <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,  </span><br><span class="line">          buyer_id <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">          create_time datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">          <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">  ) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 dbpartition <span class="keyword">by</span> RANGE_HASH(seller_id,buyer_id, <span class="number">10</span>) tbpartition <span class="keyword">by</span> RANGE_HASH(seller_id,buyer_id, <span class="number">10</span>) tbpartitions <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> multi_db_multi_tbl;</span><br></pre></td></tr></table></figure>
<h3 id="使用日期做拆分"><a href="#使用日期做拆分" class="headerlink" title="使用日期做拆分"></a>使用日期做拆分</h3><p>可以使用日期函数 MM/DD/WEEK/MMDD 来作为分表的拆分算法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_log(</span><br><span class="line">userId <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">operation <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">actionDate <span class="type">DATE</span></span><br><span class="line">) dbpartition <span class="keyword">by</span> hash(userId) tbpartition <span class="keyword">by</span> WEEK(actionDate) tbpartitions <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> user_log;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_log2(</span><br><span class="line">userId <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">operation <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">actionDate <span class="type">DATE</span></span><br><span class="line">) dbpartition <span class="keyword">by</span> hash(userId) tbpartition <span class="keyword">by</span> MM(actionDate) tbpartitions <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> topology <span class="keyword">from</span> user_log2;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="默认使用主键作为拆分字段"><a href="#默认使用主键作为拆分字段" class="headerlink" title="默认使用主键作为拆分字段"></a>默认使用主键作为拆分字段</h2><p>当拆分算法不指定任何拆分字段时，系统默认使用主键作为拆分字段。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prmkey_tbl(</span><br><span class="line">id <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line"><span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) dbpartition <span class="keyword">by</span> hash();</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prmkey_multi_tbl(</span><br><span class="line">id <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line"><span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) dbpartition <span class="keyword">by</span> hash() tbpartition <span class="keyword">by</span> hash() tbpartitions <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<h2 id="广播表"><a href="#广播表" class="headerlink" title="广播表"></a>广播表</h2><p>子句BROADCAST用来指定创建广播表。广播表是指将这个表复制到每个分库上，在分库上通过同步机制实现数据一致，有秒级延迟。<br>这样做的好处是可以将 JOIN 操作下推到底层的 RDS（MySQL)，来避免跨库 JOIN。  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> brd_tbl(</span><br><span class="line">  id <span class="type">int</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">  <span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 BROADCAST;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>直接在客户端使用DDL建表好像并不成功，尽量使用WEB控制台建表</p>
</blockquote>
<h2 id="其它操作"><a href="#其它操作" class="headerlink" title="其它操作"></a>其它操作</h2><h3 id="查看物理表的拓扑结构"><a href="#查看物理表的拓扑结构" class="headerlink" title="查看物理表的拓扑结构"></a>查看物理表的拓扑结构</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TOPOLOGY <span class="keyword">FROM</span> multi_db_multi_tbl;</span><br></pre></td></tr></table></figure>
<h3 id="查看逻辑表是否创建成功"><a href="#查看逻辑表是否创建成功" class="headerlink" title="查看逻辑表是否创建成功"></a>查看逻辑表是否创建成功</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CHECK</span> <span class="keyword">TABLE</span> multi_db_multi_tbl;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201707/%E9%80%9A%E8%BF%87Cookie%20Insertion%E5%AE%9E%E7%8E%B0Nginx%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%80%9A%E8%BF%87Cookie%20Insertion%E5%AE%9E%E7%8E%B0Nginx%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81/" class="post-title-link" itemprop="url">通过Cookie Insertion实现Nginx会话保持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-29 12:20:24" itemprop="dateCreated datePublished" datetime="2017-07-29T12:20:24+08:00">2017-07-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-06 15:36:54" itemprop="dateModified" datetime="2018-11-06T15:36:54+08:00">2018-11-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Nginx负载均衡的几种策略"><a href="#Nginx负载均衡的几种策略" class="headerlink" title="Nginx负载均衡的几种策略"></a>Nginx负载均衡的几种策略</h2><p>使用开源版本的Nginx可以轻松实现7层（HTTP）或4层（TCP）的负载均衡。  </p>
<p>当做为7层负载时，最常用的有以下几种策略：  </p>
<ul>
<li>轮询 round-robin — requests to the application servers are distributed in a round-robin fashion 依次把客户端的请求分发到不同的后端服务器上</li>
<li>最少连接 least-connected — next request is assigned to the server with the least number of active connections  请求会被转发到连接数最少的服务器上</li>
<li>IP哈希 ip-hash — a hash-function is used to determine what server should be selected for the next request (based on the client’s IP address)  同一客户端（IP）的连续的请求都会被分发到固定的一台后端服务器上</li>
</ul>
<p>前两种方案（轮询和最少连接）同一客户端的请求会被随机分配后不同的后端服务器上，如果后端是传统的有状态的WEB应用，则需要在后端WEB容器上配置Session共享，非常麻烦。</p>
<p>后一种方案（IP哈希）可以识别请求端的IP，固定将其分配到某一台后端服务器上，轻松解决了会话保持的问题。但IP哈希存在一个比较严重缺陷，即：客户端必须能够直连Nginx服务器，他们之间不能再插入其它层级，否则Nginx就识别不到客户端的IP了。  </p>
<p>那除了IP HASH外，还有没有其它方式能够进行会话保持呢？  </p>
<h2 id="Cookie-Insertion"><a href="#Cookie-Insertion" class="headerlink" title="Cookie Insertion"></a>Cookie Insertion</h2><p>以下是官网的关于Cookie Insertion的介绍：  </p>
<blockquote>
<p>Cookie Insertion：NGINX Plus adds a session cookie to the first response from the upstream group to a given client, identifying which server generated the response (in an encoded fashion). Subsequent requests from the client include the cookie value and NGINX Plus uses it to route the request to the same upstream server:</p>
</blockquote>
<p>Cookie植入:  </p>
<ol>
<li>客户端第一次访问时，负载均衡服务在返回请求中植入cookie（在HTTP/HTTPS响应报文中插入）</li>
<li>下次客户端携带此cookie访问，负载均衡服务会将请求定向转发给之前记录到的后端服务器上。</li>
</ol>
<p>Cookie植入原理上就是劫持HTTP请求，伪造cookie，它可以在Nginx无法获取客户端IP时，也依然能够完成会话保持的功能，只要客户端支持Cookie即可。</p>
<h2 id="购买并使用Nginx-Plus"><a href="#购买并使用Nginx-Plus" class="headerlink" title="购买并使用Nginx Plus"></a>购买并使用Nginx Plus</h2><p>要使用Cookie Insertion，最简便的方式是使用商业版本的Nginx Plus，默认支持。  </p>
<p>以下是官网关于会话保持的介绍：<br><a target="_blank" rel="noopener" href="https://www.nginx.com/products/session-persistence/">https://www.nginx.com/products/session-persistence/</a></p>
<p>Cookie Insertion的配置非常简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server webserver1;</span><br><span class="line">    server webserver2;</span><br><span class="line">    sticky cookie srv_id expires&#x3D;1h domain&#x3D;.example.com path&#x3D;&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是顺道了解了一下Nginx Plus的来龙去脉：  </p>
<ul>
<li>2002年，来自俄罗斯的Igor Sysoev使用C语言开发了NGINX；</li>
<li>2004年，NGINX开放源码，基于BSD开源许可。</li>
<li>2006年 - 2016年，NIGNX Rlease版本历经0.5, 0.6, 0.7, 0.8, 1.0, 1.2, 1.4, 1.6, 1.8, 1.9, 1.10, 1.11, 当前最新版本为1.11.3；</li>
<li>2011年，Sysoev成立了NGINX公司，NGINX PLUS是其第一款产品，也是NGINX的商业版本；</li>
<li>2013年 - 2016年，自NGINX Plus Initial Release (R1)版本发布以来，NGINX商业版本已更新至NGINX Plus Release 9 (R9)；</li>
</ul>
<blockquote>
<p>NGINX Plus is the all-in-one application delivery platform for the modern web.<br>All-In-One的NGINX PLUS对比开源版本重点增加了若干企业特性，包括更完善的七层、四层负载均衡，会话保持，健康检查，实时监控和管理等。</p>
</blockquote>
<p>可看了一下最便宜的BASIC版本也要2500刀每年，泪奔，果断PASS。<br><a target="_blank" rel="noopener" href="https://www.nginx.com/products/buy-nginx-plus/">https://www.nginx.com/products/buy-nginx-plus/</a></p>
<h2 id="使用第三方模块nginx-sticky-module"><a href="#使用第三方模块nginx-sticky-module" class="headerlink" title="使用第三方模块nginx-sticky-module"></a>使用第三方模块nginx-sticky-module</h2><p>阿里云SLB的Cookie植入功能，猜测应该是自已在Nginx基础上实现的，貌似没有开源。  </p>
<p>流传最广的是一个名为 <strong>nginx-sticky-module</strong> 的第3方的模块 ，不过已经有多年没有维护。</p>
<p>GoogleCode页面(需扶墙): <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/nginx-sticky-module/downloads">https://code.google.com/archive/p/nginx-sticky-module/downloads</a></p>
<p>下载 <strong>nginx-sticky-module-1.1.tar.gz</strong> ，看看能否配合较新的 <strong>nginx-1.12.1</strong> 使用。</p>
<p>Nginx下载地址： <a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a>  </p>
<blockquote>
<p>选择Stable version中的nginx-1.12.1</p>
</blockquote>
<p>简单编译一下试试：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;nginx&#x2F;nginx-1.12.1 --add-module&#x3D;&#x2F;nginx&#x2F;src&#x2F;nginx-sticky-module-1.1  </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>果然报错：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;nginx&#x2F;src&#x2F;nginx-sticky-module-1.1&#x2F;ngx_http_sticky_module.c: In function ‘ngx_http_get_sticky_peer’:</span><br><span class="line">&#x2F;nginx&#x2F;src&#x2F;nginx-sticky-module-1.1&#x2F;ngx_http_sticky_module.c:333: error: assignment makes pointer from integer without a cast</span><br><span class="line">make[1]: *** [objs&#x2F;addon&#x2F;nginx-sticky-module-1.1&#x2F;ngx_http_sticky_module.o] Error 1</span><br><span class="line">make[1]: Leaving directory &#96;&#x2F;nginx&#x2F;src&#x2F;nginx-1.12.1&#39;</span><br><span class="line">make: *** [build] Error 2</span><br></pre></td></tr></table></figure>
<p>代码太老旧，没有细查的必要了，弃用。  </p>
<h2 id="使用第三方模块nginx-sticky-module-ng"><a href="#使用第三方模块nginx-sticky-module-ng" class="headerlink" title="使用第三方模块nginx-sticky-module-ng"></a>使用第三方模块nginx-sticky-module-ng</h2><p>另外还有一个比较新的模块 <strong>nginx-sticky-module-ng</strong> ，源码托管在BitBucket上：<br><a target="_blank" rel="noopener" href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/</a>  </p>
<p>在Downloads/Tags下，找到1.2.6的源码并下载，或者直接下载Master分支上最新的代码。</p>
<p>在编译之前，首先来动手修复一个BUG。。。<br>找到<code>ngx_http_sticky_misc.c</code>，添加以下两个include:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;openssl&#x2F;sha.h&gt;</span><br><span class="line">#include &lt;openssl&#x2F;md5.h&gt;</span><br></pre></td></tr></table></figure>
<p>第三方的东西凑和着用吧。。。</p>
<p>编译一下试试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;nginx&#x2F;nginx-1.12.1 --add-module&#x3D;&#x2F;nginx&#x2F;src&#x2F;nginx-sticky-module-ng</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>编译很顺利，配置一下试试吧：<br>配置上非常简单，只需要在upstream{}中加入sticky即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upstream &#123;</span><br><span class="line">  sticky;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Sticky的详细配置说明：<br>sticky [name=route] [domain=.foo.bar] [path=/] [expires=1h]<br>       [hash=index|md5|sha1] [no_fallback] [secure] [httponly];</p>
<ul>
<li>name: the name of the cookies used to track the persistant upstream srv; default: route</li>
<li>domain: the domain in which the cookie will be valid default: nothing. Let the browser handle this.</li>
<li>path: the path in which the cookie will be valid default: /</li>
<li>expires: the validity duration of the cookie default: nothing. It’s a session cookie. restriction: must be a duration greater than one second</li>
<li>hash: the hash mechanism to encode upstream server. It cant’ be used with hmac. default: md5</li>
<li>md5|sha1: well known hash</li>
<li>index: it’s not hashed, an in-memory index is used instead, it’s quicker and the overhead is shorter Warning: the matching against upstream servers list is inconsistent. So, at reload, if upstreams servers has changed, index values are not guaranted to correspond to the same server as before! USE IT WITH CAUTION and only if you need to!</li>
<li>hmac: the HMAC hash mechanism to encode upstream server It’s like the hash mechanism but it uses hmac_key to secure the hashing. It can’t be used with hash. md5|sha1: well known hash default: none. see hash.</li>
<li>hmac_key: the key to use with hmac. It’s mandatory when hmac is set default: nothing.</li>
<li>no_fallback: when this flag is set, nginx will return a 502 (Bad Gateway or Proxy Error) if a request comes with a cookie and the corresponding backend is unavailable.</li>
<li>secure enable secure cookies; transferred only via https</li>
<li>httponly enable cookies not to be leaked via js</li>
</ul>
<p>下面给出一个完整的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  4;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    upstream proxy_admin &#123;</span><br><span class="line">        #ip_hash;</span><br><span class="line">        sticky;</span><br><span class="line">        server 192.168.1.61:19022 weight&#x3D;10 max_fails&#x3D;3 fail_timeout&#x3D;20s;</span><br><span class="line">        server 192.168.1.62:19022 weight&#x3D;10 max_fails&#x3D;3 fail_timeout&#x3D;20s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       29022;</span><br><span class="line">        server_name  proxy_admin;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            proxy_pass   http:&#x2F;&#x2F;proxy_admin;</span><br><span class="line">            proxy_next_upstream error timeout invalid_header http_500 http_503 http_404;</span><br><span class="line">            proxy_redirect off;</span><br><span class="line">            proxy_ignore_client_abort on;</span><br><span class="line">            proxy_set_header Host $host:$server_port;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_connect_timeout 60;</span><br><span class="line">            proxy_send_timeout 60;</span><br><span class="line">            proxy_read_timeout 60;</span><br><span class="line">            proxy_buffer_size 4k;</span><br><span class="line">            proxy_buffers 4 32k;</span><br><span class="line">            proxy_busy_buffers_size 64k;</span><br><span class="line">            proxy_temp_file_write_size 64k;</span><br><span class="line">            client_body_buffer_size 128k;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试，用浏览器访问一下试试：<br><a target="_blank" rel="noopener" href="http://ip:29022/mobagent-admin/">http://IP:29022/mobagent-admin/</a><br>如果在控制台中的Cookie中看到一个名为route的键，就说明基本上成功了。<br>然后多请求几次，看看后端服务的日志，最终确认一下，是不是只指向了同一台服务器。  </p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>最后，请注意，因为nginx-sticky-module-ng的可靠性未经长时间验证，请勿直接用于生产系统。  </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201707/netcat%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%89%93%E5%BC%80%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/netcat%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%89%93%E5%BC%80%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-28 16:44:14" itemprop="dateCreated datePublished" datetime="2017-07-28T16:44:14+08:00">2017-07-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="netcat的正确打开方式"><a href="#netcat的正确打开方式" class="headerlink" title="netcat的正确打开方式"></a>netcat的正确打开方式</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>nc(netcat)是一个能通过TCP和UDP读写数据的工具，很多Linux发行版已经预装。最近发现了关于nc的很多有趣的应用场景，果然名副其实，很是牛叉。。。于是简单梳理了一下。  </p>
<h2 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h2><ul>
<li>-g &lt;网关&gt; 设置路由器跃程通信网关，最丢哦可设置8个。</li>
<li>-G &lt;指向器数目&gt; 设置来源路由指向器，其数值为4的倍数。</li>
<li>-h 在线帮助。</li>
<li>-i &lt;延迟秒数&gt; 设置时间间隔，以便传送信息及扫描通信端口。</li>
<li>-l 使用监听模式，管控传入的资料。</li>
<li>-n 直接使用IP地址，而不通过域名服务器。</li>
<li>-o &lt;输出文件&gt; 指定文件名称，把往来传输的数据以16进制字码倾倒成该文件保存。</li>
<li>-p &lt;通信端口&gt; 设置本地主机使用的通信端口。</li>
<li>-r 乱数指定本地与远端主机的通信端口。</li>
<li>-s &lt;来源位址&gt; 设置本地主机送出数据包的IP地址。</li>
<li>-u 使用UDP传输协议。</li>
<li>-v 显示指令执行过程。</li>
<li>-w &lt;超时秒数&gt; 设置等待连线的时间。</li>
<li>-z 使用0输入/输出模式，只在扫描通信端口时使用。</li>
</ul>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><h3 id="测试端口连通性"><a href="#测试端口连通性" class="headerlink" title="测试端口连通性"></a>测试端口连通性</h3><p>使用<code>nc -z</code>可以测试远程主机端口的连通性。<br>以前我们测试某台远程主机的某个端口是否能连通，通常都是用<code>telnet ip port</code>，现在可以用nc来替代了。</p>
<p>示例：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -z 192.168.1.60 19011</span><br><span class="line">Connection to 192.168.1.60 port 19011 [tcp&#x2F;*] succeeded!</span><br></pre></td></tr></table></figure>

<h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><p>使用<code>-z</code>参数时，还可以指定一个端口范围进行扫描。<br>以后简单场景下，就不需要动用<code>nmap</code>这种专业工具了。  </p>
<p>示例：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TCP:</span><br><span class="line">nc -z -v 192.168.1.60 19000-19100 2&gt;&amp;1 | grep succeeded</span><br><span class="line"></span><br><span class="line">UDP:</span><br><span class="line">nc -z -v -u 192.168.1.60 19000-19100 2&gt;&amp;1 | grep succeeded</span><br></pre></td></tr></table></figure>

<h3 id="启监听端口"><a href="#启监听端口" class="headerlink" title="启监听端口"></a>启监听端口</h3><p>很多时候，如果拜托网管为我们做一个NAT映射，或新配置了一个防火墙策略后，通常要启一个临时的tomcat/apache/nginx行测试，非常麻烦。<br>如果只是临时测试的话，直接使用<code>nc -l 端口号</code>就可以启一个监听了，如果早点知道的话就可以省去很多时间了。  </p>
<p>示例：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -l 33333</span><br></pre></td></tr></table></figure>
<h3 id="HTTP服务健康监控"><a href="#HTTP服务健康监控" class="headerlink" title="HTTP服务健康监控"></a>HTTP服务健康监控</h3><p><code>nc</code>配合<code>echo</code>来使用，可以模拟发送一段HTTP请求报文，对一个HTTP服务进行健康度检测。<br>如果服务支持HEAD方法的话，可以尽量使用HEAD以减轻测试时对服务端的压力。<br>于是简单场景下，我们又可以抛弃<code>wget</code>和<code>curl</code>了。。。</p>
<p>示例：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo -e &quot;GET &#x2F;mobsale-service&#x2F;health HTTP&#x2F;1.0\r\n\r\n&quot; |nc -t 192.168.1.60 19011</span><br><span class="line">echo -e &quot;HEAD &#x2F;mobsale-service&#x2F;client HTTP&#x2F;1.0\r\n\r\n&quot; |nc -t 192.168.1.60 19011</span><br></pre></td></tr></table></figure>

<h3 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h3><p>通常，我们在两台服务器之前传递文件，首选都是<code>sftp</code>/<code>scp</code>，或者<code>ftp</code>，或者更古老的<code>sz</code>/<code>rz</code>。<br>但如果这些方式都被禁用的话怎么办呢？可以用nc来自己铺路，只要能连网，就能传文件！  </p>
<p>示例：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">传递方：</span><br><span class="line">cat readme.txt | nc -l 33333</span><br><span class="line"></span><br><span class="line">收接方：</span><br><span class="line">nc 192.168.1.61 33333 &gt; readme.txt</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果要传递目录的话，需要配合tar/zip等工具进行打包。  </p>
</blockquote>
<h3 id="聊天工具"><a href="#聊天工具" class="headerlink" title="聊天工具"></a>聊天工具</h3><p>还可以使用nc来进行单方向聊天，这貌似是一个然并卵的东西。。。<br>和文件传输的原理其实是一样的。  </p>
<p>示例：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">接收方：</span><br><span class="line">nc -l 33333</span><br><span class="line"></span><br><span class="line">发送方：</span><br><span class="line">nc 192.168.1.61 33333</span><br></pre></td></tr></table></figure>
<blockquote>
<p>发送发输入内容回车之后，接收方就会显示了</p>
</blockquote>
<h3 id="简易WEB服务器"><a href="#简易WEB服务器" class="headerlink" title="简易WEB服务器"></a>简易WEB服务器</h3><p>不借助<code>tomcat</code>/<code>nginx</code>/<code>httpd</code>等WEB容器，仅用nc就可以用快速搭建一个单页面的WEB服务器。  </p>
<p>首先新建一个index.html文件：  </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">title</span>&gt;</span>Test Page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>It Works!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>执行以下脚本，将一个简单的HEAD与index.html中的BODY拼接并输出：  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while true;do &#123; printf &#x27;%b\r\n&#x27; &#x27;HTTP/1.1 200 OK&#x27; &#x27;%b\r\n&#x27;;cat index.html; &#125;|nc -l 33333;done</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在浏览器上输入<a href="http://ip:port/whatever">http://ip:port/whatever</a> 就可以看到刚才的页面了</p>
</blockquote>
<h3 id="远程桌面"><a href="#远程桌面" class="headerlink" title="远程桌面"></a>远程桌面</h3><p>设想如下场景：<br>如果某台远程主机禁用了某用户（例如root）的SSH远程登录权限，只能通过低权限的管理用户登录，再用<code>su -</code>的方式切换过去进行操作。如果觉得不爽，有没有可能绕过这个限制呢？<br>使用nc就可以在远程新开一个任意监听端口，然后在本地就可以模拟SSH登录了，可以说是命令行版的”远程桌面”吧。  </p>
<p>原理如下：  </p>
<ol>
<li>从网络收到命令写入fifo文件中</li>
<li>cat命令读取fifo文件，并且发送到bash命令</li>
<li>bash执行完的结果发送给nc</li>
<li>nc通过网络把内容发送给客户端</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">远程：  </span><br><span class="line">mkfifo /tmp/tmp_fifo; cat /tmp/tmp_fifo | /bin/bash -i 2&gt;&amp;1 | nc -l 33333 &gt; /tmp/tmp_fifo</span><br><span class="line"></span><br><span class="line">本地：  </span><br><span class="line">nc -n 192.168.1.60 33333</span><br></pre></td></tr></table></figure>
<h3 id="四层反向代理"><a href="#四层反向代理" class="headerlink" title="四层反向代理"></a>四层反向代理</h3><p>与上面的”模拟SSH登录”原理类似，nc的另一个场景是可以充当一个4层的反向代理，这个比较实用了，LVS/HA/Nginx统统都可以下岗了。。。</p>
<p>示例：  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfifo backpipe; nc -l 33333  0&lt;backpipe | nc 192.168.1.60 19011 1&gt;backpipe</span><br></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>大体先写这么多了，以后的使用过程中如果还有新的发现，随时补充。  </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201707/%E9%98%BF%E9%87%8C%E4%BA%91RDS&DRDS%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%98%BF%E9%87%8C%E4%BA%91RDS&DRDS%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">阿里云RDS&DRDS初探</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-26 17:02:32" itemprop="dateCreated datePublished" datetime="2017-07-26T17:02:32+08:00">2017-07-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-26 09:44:33" itemprop="dateModified" datetime="2021-01-26T09:44:33+08:00">2021-01-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="RDS"><a href="#RDS" class="headerlink" title="RDS"></a>RDS</h3><blockquote>
<p>阿里云关系型数据库（Relational Database Service，简称 RDS）是一种稳定可靠、可弹性伸缩的在线数据库服务。基于阿里云分布式文件系统和高性能存储，RDS 支持 MySQL、SQL Server、PostgreSQL 和 PPAS（Postgre Plus Advanced Server，一种高度兼容 Oracle 的数据库）引擎，并且提供了容灾、备份、恢复、监控、迁移等方面的全套解决方案，彻底解决数据库运维的烦恼。</p>
</blockquote>
<p><strong>RDS for MySQL</strong> 可以认为是云上的MySQL。目前可选的版本有5.5/5.6，部分区域可选择5.7。  </p>
<h3 id="DRDS"><a href="#DRDS" class="headerlink" title="DRDS"></a>DRDS</h3><blockquote>
<p>分布式关系型数据库服务（Distributed Relational Database Service，简称 DRDS）是阿里巴巴致力于解决单机数据库服务瓶颈问题而自主研发推出的分布式数据库产品。DRDS 高度兼容 MySQL 协议和语法，支持自动化水平拆分、在线平滑扩缩容、弹性扩展、透明读写分离，具备数据库全生命周期运维管控能力。DRDS 前身为淘宝 TDDL，是近千核心应用首选组件。</p>
</blockquote>
<p><strong>DRDS</strong> 可以认为是云上的TDDL中间件。DRDS必须依赖RDS。  </p>
<h2 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h2><h3 id="RDS首页"><a href="#RDS首页" class="headerlink" title="RDS首页"></a>RDS首页</h3><p><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/rds/mysql">https://www.aliyun.com/product/rds/mysql</a></p>
<h3 id="RDS控制台"><a href="#RDS控制台" class="headerlink" title="RDS控制台"></a>RDS控制台</h3><p><a target="_blank" rel="noopener" href="https://rdsnew.console.aliyun.com/">https://rdsnew.console.aliyun.com</a></p>
<h3 id="RDS文档"><a href="#RDS文档" class="headerlink" title="RDS文档"></a>RDS文档</h3><p><a target="_blank" rel="noopener" href="https://help.aliyun.com/product/26090.html">https://help.aliyun.com/product/26090.html</a></p>
<h3 id="DRDS首页"><a href="#DRDS首页" class="headerlink" title="DRDS首页"></a>DRDS首页</h3><p><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/drds">https://www.aliyun.com/product/drds</a></p>
<h3 id="DRDS控制台"><a href="#DRDS控制台" class="headerlink" title="DRDS控制台"></a>DRDS控制台</h3><p><a target="_blank" rel="noopener" href="https://drds.console.aliyun.com/prectrl/home/index">https://drds.console.aliyun.com/prectrl/home/index</a></p>
<blockquote>
<p>DRDS控制台不在左侧快捷菜单中，可以直接通过链接进入</p>
</blockquote>
<h3 id="DRDS文档"><a href="#DRDS文档" class="headerlink" title="DRDS文档"></a>DRDS文档</h3><p><a target="_blank" rel="noopener" href="https://help.aliyun.com/product/29657.html">https://help.aliyun.com/product/29657.html</a></p>
<h2 id="RDS初探"><a href="#RDS初探" class="headerlink" title="RDS初探"></a>RDS初探</h2><ol>
<li><p>进入控制台，点击右侧的”创建实例”<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/98xvs.jpg">  </p>
<blockquote>
<p>创建RDS实例需要几分钟的时间</p>
</blockquote>
</li>
<li><p>按量付费，最低配置的RDS实例，目前为0.324元/小时<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/etmui.jpg"></p>
<blockquote>
<p>这里选择5.6版本，猜测在工具的支持上BUG会少一些    </p>
</blockquote>
</li>
<li><p>在实例列表中可以看到已创建的实例<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/e34py.jpg"><br>点击进入详情页可以进行实例状态查看以及管理<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/d3t0z.jpg">  </p>
</li>
<li><p>创建数据库、创建帐号的操作比较简单，不再赘述。  </p>
</li>
<li><p>添加IP白名单<br>首先，在数据安全性中，将default分组中的127.0.0.1临时改为0.0.0.0/0，允许所有地址访问<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/seljp.jpg"><br>登录数据库：<br>mysql -hrm-xxxxxxxxxxx.mysql.rds.aliyuncs.com -P3306 -utestuser -p<br>查询当前IP：<br>show processlist;<br>在数据安全性中，尽快将default分组中的IP由0.0.0.0/0改回当前的真实的IP。  </p>
</li>
<li><p>登录数据库<br>接下来可以用命令行或第三方工具进行登录。RDS不提供root用户。  </p>
</li>
<li><p>其它功能<br>另外可以添加只读实例、灾备实例，按需购买即可，猜测原理应该是基于主从复制的。<br>另外可以在WEB界面中进行数据迁移、导入等操作。<br>WEB控制台中提供了比较完善的日志查询、慢SQL分析、监控与告警功能点，有时间可以慢慢探索。  </p>
</li>
</ol>
<h2 id="DRDS初探"><a href="#DRDS初探" class="headerlink" title="DRDS初探"></a>DRDS初探</h2><ol>
<li><p>进入控制台，点击右侧的”创建实例”。<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/dnf0x.jpg">  </p>
</li>
<li><p>按量付费，共享实例的DRDS，目前价格为0.2元/小时。<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/murxc.jpg">  </p>
<blockquote>
<p>按量后付费的需要提前向帐户中充值  </p>
</blockquote>
</li>
<li><p>购买后创建过程非常快，马上就可以在概览中看到。<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/2anc1.jpg">  </p>
</li>
<li><p>进入”详情”页面后，目前DRDS下还没有数据库，可以点击下方链接进行创建。<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/pk7r3.jpg">  </p>
<blockquote>
<p>请注意： 此步骤依赖于RDS，需要先进行RDS的购买。<br>RDS购买时，请注意需要在同一个区域中，尽量不要跨区。  </p>
</blockquote>
</li>
<li><p>如果已经购买过RDS，并创建了一个实例，就在左侧的实例清单中就可以选择到了。<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/3yyc2.jpg">  </p>
</li>
<li><p>填写基本信息，创建类型这里选择”拆分”。设置好数据库名及密码。<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/a083z.jpg">  </p>
<blockquote>
<p>拆分：即分库分表，将数据按照拆分规则分拆到多个库表中，由 DRDS 代理 SQL 执行。拆分涉及到数据导入导出、SQL 功能/性能测试和改造，对应用功能和性能会有一定的影响。  </p>
<p>非拆分：将已有的 RDS 数据库交由 DRDS 进行代理访问，实现读写分离的功能。无需进行数据导入，无需修改程序代码，修改数据库连接串和用户名密码即可。  </p>
</blockquote>
</li>
<li><p>系统会自动在RDS实例上创建8个分库，直接点”下一步”创建成功。<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/3aiuf.jpg">  </p>
<blockquote>
<p>创建数据库需要几分钟的时间  </p>
</blockquote>
</li>
<li><p>创建完成后，可以在DRDS数库列表中看到<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/gfi7s.jpg"><br>在RDS控制台中也可以看到自动创建的8+1个库，绑定帐号名随机生成，密码与DRDS密码是不同的，估计也是随机生成，所以无法直接登录查看RDS库，只能在DRDS中统一管理。<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/e2o0b.jpg"></p>
</li>
<li><p>点击”管理”，可以查看详情页面<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/b0klv.jpg"></p>
</li>
<li><p>WEB界面登录<br>详情页面，点击上方的”登录数据库”按钮，有一个WEB图形化控制台<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/3wmvn.jpg"><br>但点击登录后，会报错：Access denied for user ‘ xx’@’xx.xx.xx.xx’<br>原因未知，有可能是IP限制。官方文档中也未给出示例。  </p>
</li>
<li><p>命令行登录<br>可以使用命令行登录<br><code>mysql -hdrdsxxxxxxxxpublic.drds.aliyuncs.com -P3306 -uyourname -p</code><br>版本显示为 5.6.29-TDDL-5.1.27-1217986  </p>
</li>
<li><p>第三方客户端登录<br>可以使用第三方客户端登录，如Sequel Pro，也可以正常登录。<br>（之前用过的的Cobar/MyCat都是比较挑客户端的）<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/0n8ti.jpg">  </p>
</li>
<li><p>在DRDS执行一个简单的建表语句测试  </p>
<p>建一个普通表：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> normal_table(</span><br><span class="line">id <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line"><span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
<p>建一个分库表：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> shard_table(</span><br><span class="line">id <span class="type">int</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line"><span class="keyword">primary</span> <span class="keyword">key</span>(id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 dbpartition <span class="keyword">by</span> hash(id) tbpartition <span class="keyword">by</span> hash(id) tbpartitions <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<p>在WEB控制台中可以查看表的基本信息：<br><img src="https://bluexiii.oss-cn-beijing.aliyuncs.com/rbjed.jpg"></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://blog.bluexiii.com/201707/%E9%98%BF%E9%87%8C%E4%BA%91OSS%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="BlueXIII">
      <meta itemprop="description" content="IT技术类文章、笔记分享">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlueXIII's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/201707/%E9%98%BF%E9%87%8C%E4%BA%91OSS%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E7%A4%BA%E4%BE%8B/" class="post-title-link" itemprop="url">阿里云OSS对象存储示例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-24 20:54:47" itemprop="dateCreated datePublished" datetime="2017-07-24T20:54:47+08:00">2017-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-11-06 15:36:33" itemprop="dateModified" datetime="2018-11-06T15:36:33+08:00">2018-11-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="DEMO-GitLab"><a href="#DEMO-GitLab" class="headerlink" title="DEMO GitLab"></a>DEMO GitLab</h2><blockquote>
<p>更多源码请移步GitHub<br><a target="_blank" rel="noopener" href="https://github.com/xiiiblue/demo-oss">https://github.com/xiiiblue/demo-oss</a></p>
</blockquote>
<h2 id="OSS-SDK下载"><a href="#OSS-SDK下载" class="headerlink" title="OSS SDK下载"></a>OSS SDK下载</h2><p><a target="_blank" rel="noopener" href="https://promotion.aliyun.com/ntms/act/ossdoclist.html">https://promotion.aliyun.com/ntms/act/ossdoclist.html</a></p>
<h2 id="OSS-SDK源码"><a href="#OSS-SDK源码" class="headerlink" title="OSS SDK源码"></a>OSS SDK源码</h2><p><a target="_blank" rel="noopener" href="https://github.com/aliyun/aliyun-oss-java-sdk">https://github.com/aliyun/aliyun-oss-java-sdk</a></p>
<h2 id="OSS-Maven依赖"><a href="#OSS-Maven依赖" class="headerlink" title="OSS Maven依赖"></a>OSS Maven依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="OSS官方文档"><a href="#OSS官方文档" class="headerlink" title="OSS官方文档"></a>OSS官方文档</h2><p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/32009.html">https://help.aliyun.com/document_detail/32009.html</a></p>
<h2 id="申请及配置OSS流程"><a href="#申请及配置OSS流程" class="headerlink" title="申请及配置OSS流程"></a>申请及配置OSS流程</h2><ol>
<li><p>登录aliyun后，进入OSS控制台:<br><a target="_blank" rel="noopener" href="https://oss.console.aliyun.com/overview">https://oss.console.aliyun.com/overview</a></p>
</li>
<li><p>右侧点击”购买资源包”，选择合适的档位，付费购买。</p>
</li>
<li><p>右侧点击”新建Bucket”，输入一个全局唯一的bucket名，并选择所属地域，新建Bucket。</p>
</li>
<li><p>左侧列表中，进入新建的Bucket，可以查询到”Endpoint”</p>
</li>
<li><p>获取AK，可以直接访问链接：<br><a target="_blank" rel="noopener" href="https://ak-console.aliyun.com/#/accesskey">https://ak-console.aliyun.com/#/accesskey</a></p>
</li>
</ol>
<h2 id="常用操作示例"><a href="#常用操作示例" class="headerlink" title="常用操作示例"></a>常用操作示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(OssComponent.class);</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;aliyun.oss.endpoint&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String endpoint;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OSSClient ossClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过bucket与fileKey获取URL</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">urlFromFileKey</span><span class="params">(String bucket, String fileKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;http://&quot;</span> + bucket + <span class="string">&quot;.&quot;</span> + <span class="keyword">this</span>.endpoint + <span class="string">&quot;/&quot;</span> + fileKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传本地文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket   Bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath 本地文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey  指定OSS文件名，传空时自动生成UUID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> FileNotFoundException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">putObject</span><span class="params">(String bucket, String filePath, String fileKey)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fileKey == <span class="keyword">null</span>) &#123;</span><br><span class="line">        fileKey = UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>) + filePath.substring(filePath.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ossClient.putObject(bucket, fileKey, <span class="keyword">new</span> File(filePath));</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;OSS putObject success! fileKey=&#123;&#125;&quot;</span>, fileKey);</span><br><span class="line">    <span class="keyword">return</span> fileKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下载文件到本地目录</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket    Bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey   OSS文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localPath 本地文件目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getObject</span><span class="params">(String bucket, String fileKey, String localPath)</span> </span>&#123;</span><br><span class="line">    String localFileKey = localPath + fileKey;</span><br><span class="line">    ossClient.getObject(<span class="keyword">new</span> GetObjectRequest(bucket, fileKey), <span class="keyword">new</span> File(localFileKey));</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;OSS getObject success! localFileKey=&#123;&#125;&quot;</span>, localFileKey);</span><br><span class="line">    <span class="keyword">return</span> localFileKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查文件是否存在</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  Bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey OSS文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkObject</span><span class="params">(String bucket, String fileKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ossClient.doesObjectExist(bucket, fileKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列出所有文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket    Bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keyPrifix 文件名前缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">listObjects</span><span class="params">(String bucket, String keyPrifix)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; fileList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    ObjectListing objectListing = ossClient.listObjects(bucket, keyPrifix);</span><br><span class="line">    List&lt;OSSObjectSummary&gt; sums = objectListing.getObjectSummaries();</span><br><span class="line">    <span class="keyword">for</span> (OSSObjectSummary s : sums) &#123;</span><br><span class="line">        fileList.add(bucket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fileList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileKey</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteObject</span><span class="params">(String bucket, String fileKey)</span> </span>&#123;</span><br><span class="line">    ossClient.deleteObject(bucket, fileKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(OssComponentTest.class);</span><br><span class="line"><span class="keyword">private</span> String localPath;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">OssComponent ossComponent;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OssComponentTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    localPath = System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;upload/&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">urlFromFileKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String fileKey = <span class="string">&quot;0c2eb1357a454c71b71aa20462951ac4.jpg&quot;</span>;</span><br><span class="line">    String url = ossComponent.urlFromFileKey(bucket, fileKey);</span><br><span class="line"></span><br><span class="line">    logger.debug(url);</span><br><span class="line">    assertNotNull(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String filePath = localPath + <span class="string">&quot;sonic.jpg&quot;</span>;</span><br><span class="line"></span><br><span class="line">    String fileKey = ossComponent.putObject(bucket, filePath, <span class="keyword">null</span>);</span><br><span class="line">    logger.debug(fileKey);</span><br><span class="line">    assertNotNull(fileKey);</span><br><span class="line"></span><br><span class="line">    fileKey = ossComponent.putObject(bucket, filePath, <span class="string">&quot;sonic.jpg&quot;</span>);</span><br><span class="line">    logger.debug(fileKey);</span><br><span class="line">    assertNotNull(fileKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String fileKey = <span class="string">&quot;0c2eb1357a454c71b71aa20462951ac4.jpg&quot;</span>;</span><br><span class="line">    String localPath = <span class="keyword">this</span>.localPath;</span><br><span class="line"></span><br><span class="line">    String localFileKey = ossComponent.getObject(bucket, fileKey, localPath);</span><br><span class="line"></span><br><span class="line">    logger.debug(localFileKey);</span><br><span class="line">    assertNotNull(localFileKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String fileKey = <span class="string">&quot;0c2eb1357a454c71b71aa20462951ac4.jpg&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> flag = ossComponent.checkObject(bucket, fileKey);</span><br><span class="line"></span><br><span class="line">    assertTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listObjects</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String keyPrifix = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; list = ossComponent.listObjects(bucket, keyPrifix);</span><br><span class="line"></span><br><span class="line">    logger.debug(list.toString());</span><br><span class="line">    assertTrue(list.size() &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String bucket = <span class="string">&quot;foobar&quot;</span>;</span><br><span class="line">    String fileKey = <span class="string">&quot;sonic.jpg&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ossComponent.deleteObject(bucket, fileKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/17/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/19/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">BlueXIII</p>
  <div class="site-description" itemprop="description">IT技术类文章、笔记分享</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">223</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xiiiblue" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiiiblue" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/bluexiii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;bluexiii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备18050487号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BlueXIII</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
